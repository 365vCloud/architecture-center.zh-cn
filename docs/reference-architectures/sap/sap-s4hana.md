---
title: 适用于 Azure 上 Linux 虚拟机的 SAP S/4HANA
description: 有关在 Azure 上的高可用性 Linux 环境中运行 SAP S/4HANA 的成熟做法。
author: lbrader
ms.date: 05/11/2018
ms.openlocfilehash: ab056a01f05bde9e9dc7a4439baed367ee663f93
ms.sourcegitcommit: 94d50043db63416c4d00cebe927a0c88f78c3219
ms.translationtype: HT
ms.contentlocale: zh-CN
ms.lasthandoff: 09/28/2018
ms.locfileid: "47429581"
---
# <a name="sap-s4hana-for-linux-virtual-machines-on-azure"></a><span data-ttu-id="db865-103">适用于 Azure 上 Linux 虚拟机的 SAP S/4HANA</span><span class="sxs-lookup"><span data-stu-id="db865-103">SAP S/4HANA for Linux Virtual Machines on Azure</span></span>

<span data-ttu-id="db865-104">此参考体系结构演示有关在 Azure 上支持灾难恢复的高可用性环境中运行 S/4HANA 的一套成熟做法。</span><span class="sxs-lookup"><span data-stu-id="db865-104">This reference architecture shows a set of proven practices for running S/4HANA in a high availability environment that supports disaster recovery on Azure.</span></span> <span data-ttu-id="db865-105">将使用可根据组织需求更改的特定虚拟机 (VM) 大小部署此体系结构。</span><span class="sxs-lookup"><span data-stu-id="db865-105">This architecture is deployed with specific virtual machine (VM) sizes that can be changed to accommodate your organization's needs.</span></span> 

![](./images/sap-s4hana.png)

<span data-ttu-id="db865-106">下载此体系结构的 [Visio 文件][visio-download]。</span><span class="sxs-lookup"><span data-stu-id="db865-106">*Download a [Visio file][visio-download] of this architecture.*</span></span>

> [!NOTE] 
> <span data-ttu-id="db865-107">部署此参考体系结构需要获取 SAP 产品和其他非 Microsoft 技术的相应许可。</span><span class="sxs-lookup"><span data-stu-id="db865-107">Deploying this reference architecture requires appropriate licensing of SAP products and other non-Microsoft technologies.</span></span>

## <a name="architecture"></a><span data-ttu-id="db865-108">体系结构</span><span class="sxs-lookup"><span data-stu-id="db865-108">Architecture</span></span>
 
<span data-ttu-id="db865-109">此参考体系结构描述一个企业规模的生产级系统。</span><span class="sxs-lookup"><span data-stu-id="db865-109">This reference architecture describes a enterprise-grade, production-level system.</span></span> <span data-ttu-id="db865-110">可根据业务需求，将此配置缩减为单个虚拟机。</span><span class="sxs-lookup"><span data-stu-id="db865-110">To suit your business needs, this configuration can be reduced to a single virtual machine.</span></span> <span data-ttu-id="db865-111">但是，以下组件是必需的：</span><span class="sxs-lookup"><span data-stu-id="db865-111">However, the following components are required:</span></span>

<span data-ttu-id="db865-112">虚拟网络。</span><span class="sxs-lookup"><span data-stu-id="db865-112">**Virtual network**.</span></span> <span data-ttu-id="db865-113">[Azure 虚拟网络](/azure/virtual-network/virtual-networks-overview)服务在 Azure 资源之间建立安全连接。</span><span class="sxs-lookup"><span data-stu-id="db865-113">The [Azure Virtual Network](/azure/virtual-network/virtual-networks-overview) service securely connects Azure resources to each other.</span></span> <span data-ttu-id="db865-114">在此体系结构中，虚拟网络将通过[中心-分支拓扑](../hybrid-networking/hub-spoke.md)的中心内部署的网关连接到本地环境。</span><span class="sxs-lookup"><span data-stu-id="db865-114">In this architecture, the virtual network connects to an on-premises environment through a gateway deployed in the hub of a [hub-spoke topology](../hybrid-networking/hub-spoke.md).</span></span> <span data-ttu-id="db865-115">分支是用于 SAP 应用程序的虚拟网络。</span><span class="sxs-lookup"><span data-stu-id="db865-115">The spoke is the virtual network used for the SAP applications.</span></span>

<span data-ttu-id="db865-116">**子网**。</span><span class="sxs-lookup"><span data-stu-id="db865-116">**Subnets**.</span></span> <span data-ttu-id="db865-117">虚拟网络针对以下每个层划分为单独的[子网](/azure/virtual-network/virtual-network-manage-subnet)：网关、应用、数据库和共享服务。</span><span class="sxs-lookup"><span data-stu-id="db865-117">The virtual network is subdivided into separate [subnets](/azure/virtual-network/virtual-network-manage-subnet) for each tier: gateway, application, database, and shared services .</span></span> 

<span data-ttu-id="db865-118">**虚拟机**。</span><span class="sxs-lookup"><span data-stu-id="db865-118">**Virtual machines**.</span></span> <span data-ttu-id="db865-119">此体系结构对应用层和数据库层使用运行 Linux 的虚拟机。这些层划分为：</span><span class="sxs-lookup"><span data-stu-id="db865-119">This architecture uses virtual machines running Linux for the application tier and database tier, grouped as follows:</span></span>

- <span data-ttu-id="db865-120">**应用层**。</span><span class="sxs-lookup"><span data-stu-id="db865-120">**Application tier**.</span></span> <span data-ttu-id="db865-121">包括 Fiori 前端服务器池、SAP Web 调度程序池、应用程序服务器池和 SAP Central Services 群集。</span><span class="sxs-lookup"><span data-stu-id="db865-121">Includes the Fiori Front-end Server pool, SAP Web Dispatcher pool, application server pool, and SAP Central Services cluster.</span></span> <span data-ttu-id="db865-122">要在 Azure Linux 虚拟机上实现 Central Services 的高可用性，需要一个高度可用的网络文件系统 (NFS) 服务。</span><span class="sxs-lookup"><span data-stu-id="db865-122">For high availability of Central Services on Azure Linux virtual machines, a highly available Network File System (NFS) service is required.</span></span>
- <span data-ttu-id="db865-123">**NFS 群集**。</span><span class="sxs-lookup"><span data-stu-id="db865-123">**NFS cluster**.</span></span> <span data-ttu-id="db865-124">此体系结构使用 Linux 群集上运行的 [NFS](/azure/virtual-machines/workloads/sap/high-availability-guide-suse-nfs) 服务器来存储 SAP 系统之间共享的数据。</span><span class="sxs-lookup"><span data-stu-id="db865-124">This architecture uses an [NFS](/azure/virtual-machines/workloads/sap/high-availability-guide-suse-nfs) server running on a Linux cluster to store data shared between SAP systems.</span></span> <span data-ttu-id="db865-125">可在多个 SAP 系统之间共享此集中式群集。</span><span class="sxs-lookup"><span data-stu-id="db865-125">This centralized cluster can be shared across multiple SAP systems.</span></span> <span data-ttu-id="db865-126">为实现 NFS 服务的高可用性，使用了所选 Linux 分发版的相应高可用性扩展。</span><span class="sxs-lookup"><span data-stu-id="db865-126">For high availability of the NFS service, the appropriate High Availability Extension for the selected Linux distribution is used.</span></span>
- <span data-ttu-id="db865-127">**SAP HANA**。</span><span class="sxs-lookup"><span data-stu-id="db865-127">**SAP HANA**.</span></span> <span data-ttu-id="db865-128">数据库层使用群集中的两个或更多个 Linux 虚拟机来实现高可用性。</span><span class="sxs-lookup"><span data-stu-id="db865-128">The database tier uses two or more Linux virtual machines in a cluster to achieve high availability.</span></span> <span data-ttu-id="db865-129">HANA 系统复制 (HSR) 用于在主要和辅助 HANA 系统之间复制内容。</span><span class="sxs-lookup"><span data-stu-id="db865-129">HANA System Replication (HSR) is used to replicate contents between primary and secondary HANA systems.</span></span> <span data-ttu-id="db865-130">Linux 群集用于检测系统故障，以及方便自动故障转移。</span><span class="sxs-lookup"><span data-stu-id="db865-130">Linux clustering is used to detect system failures and facilitate automatic failover.</span></span> <span data-ttu-id="db865-131">基于存储或基于云的隔离机制可用于确保有故障的系统被隔离或关闭，以避免群集出现裂脑状态。</span><span class="sxs-lookup"><span data-stu-id="db865-131">A storage-based or cloud-based fencing mechanism can be used to ensure the failed system is isolated or shut down to avoid the cluster split-brain condition.</span></span>
- <span data-ttu-id="db865-132">**Jumpbox**。</span><span class="sxs-lookup"><span data-stu-id="db865-132">**Jumpbox**.</span></span> <span data-ttu-id="db865-133">也称为守护主机。</span><span class="sxs-lookup"><span data-stu-id="db865-133">Also called a bastion host.</span></span> <span data-ttu-id="db865-134">这是网络中的一个安全虚拟机，管理员使用它来连接其他虚拟机。</span><span class="sxs-lookup"><span data-stu-id="db865-134">This is a secure virtual machine on the network that administrators use to connect to the other virtual machines.</span></span> <span data-ttu-id="db865-135">该虚拟机可以运行 Windows 或 Linux。</span><span class="sxs-lookup"><span data-stu-id="db865-135">It can run Windows or Linux.</span></span> <span data-ttu-id="db865-136">使用 HANA Cockpit 或 HANA Studio 管理工具时，可以使用 Windows Jumpbox 以方便进行 Web 浏览。</span><span class="sxs-lookup"><span data-stu-id="db865-136">Use a Windows jumpbox for web browsing convenience when using HANA Cockpit or HANA Studio management tools.</span></span>

<span data-ttu-id="db865-137">**负载均衡器**。</span><span class="sxs-lookup"><span data-stu-id="db865-137">**Load balancers**.</span></span> <span data-ttu-id="db865-138">使用内置的 SAP 负载均衡器和 [Azure 负载均衡器](/azure/load-balancer/load-balancer-overview)来实现高可用性。</span><span class="sxs-lookup"><span data-stu-id="db865-138">Both built-in SAP load balancers and [Azure Load Balancer](/azure/load-balancer/load-balancer-overview) are used to achieve HA.</span></span> <span data-ttu-id="db865-139">Azure 负载均衡器实例用于将流量分配到应用层子网中的虚拟机。</span><span class="sxs-lookup"><span data-stu-id="db865-139">Azure Load Balancer instances are used to distribute traffic to virtual machines in the application tier subnet.</span></span>

<span data-ttu-id="db865-140">**可用性集**。</span><span class="sxs-lookup"><span data-stu-id="db865-140">**Availability sets**.</span></span> <span data-ttu-id="db865-141">用于所有池和群集（Web 调度程序、SAP 应用程序服务器、Central Services、NFS 和 HANA）的虚拟机已分组到单独的[可用性集](/azure/virtual-machines/windows/tutorial-availability-sets)，并为每个角色至少预配两个虚拟机。</span><span class="sxs-lookup"><span data-stu-id="db865-141">Virtual machines for all pools and clusters (Web Dispatcher, SAP application servers, Central Services, NFS, and HANA) are grouped into separate [availability sets](/azure/virtual-machines/windows/tutorial-availability-sets), and at least two virtual machines are provisioned per role.</span></span> <span data-ttu-id="db865-142">这样，虚拟机便可以满足更高的[服务级别协议 (SLA)](https://azure.microsoft.com/support/legal/sla/virtual-machines)。</span><span class="sxs-lookup"><span data-stu-id="db865-142">This makes the virtual machines eligible for a higher [service level agreement](https://azure.microsoft.com/support/legal/sla/virtual-machines) (SLA).</span></span> 

<span data-ttu-id="db865-143">**NIC**。</span><span class="sxs-lookup"><span data-stu-id="db865-143">**NICs**.</span></span> <span data-ttu-id="db865-144">[网络接口卡](/azure/virtual-network/virtual-network-network-interface) (NIC) 使虚拟网络中的虚拟机能够实现各种通信。</span><span class="sxs-lookup"><span data-stu-id="db865-144">[Network interface cards](/azure/virtual-network/virtual-network-network-interface) (NICs) enable all communication of virtual machines on a virtual network.</span></span>

<span data-ttu-id="db865-145">**网络安全组**。</span><span class="sxs-lookup"><span data-stu-id="db865-145">**Network security groups**.</span></span> <span data-ttu-id="db865-146">若要限制虚拟网络中的传入、传出和子网内部流量，可以使用[网络安全组](/azure/virtual-network/virtual-networks-nsg) (NSG)。</span><span class="sxs-lookup"><span data-stu-id="db865-146">To restrict incoming, outgoing, and intra-subnet traffic in the virtual network, [network security groups](/azure/virtual-network/virtual-networks-nsg) (NSGs) are used.</span></span>

<span data-ttu-id="db865-147">**网关**。</span><span class="sxs-lookup"><span data-stu-id="db865-147">**Gateway**.</span></span> <span data-ttu-id="db865-148">网关将本地网络扩展到 Azure 虚拟网络。</span><span class="sxs-lookup"><span data-stu-id="db865-148">A gateway extends your on-premises network to the Azure virtual network.</span></span> <span data-ttu-id="db865-149">建议使用 [ExpressRoute](/azure/architecture/reference-architectures/hybrid-networking/expressroute) Azure 服务来创建不必经由公共 Internet 的专用连接，但也可以使用[站点到站点](/azure/vpn-gateway/vpn-gateway-howto-site-to-site-resource-manager-portal)连接。</span><span class="sxs-lookup"><span data-stu-id="db865-149">[ExpressRoute](/azure/architecture/reference-architectures/hybrid-networking/expressroute) is the recommended Azure service for creating private connections that do not go over the public Internet, but a [Site-to-Site](/azure/vpn-gateway/vpn-gateway-howto-site-to-site-resource-manager-portal) connection can also be used.</span></span> 

<span data-ttu-id="db865-150">**Azure 存储**。</span><span class="sxs-lookup"><span data-stu-id="db865-150">**Azure Storage**.</span></span> <span data-ttu-id="db865-151">若要提供虚拟机的虚拟硬盘 (VHD) 持久存储，必须使用 [Azure 存储](/azure/storage/)。</span><span class="sxs-lookup"><span data-stu-id="db865-151">To provide persistent storage of a virtual machine's virtual hard disk (VHD), [Azure Storage](/azure/storage/) is required.</span></span> 

## <a name="recommendations"></a><span data-ttu-id="db865-152">建议</span><span class="sxs-lookup"><span data-stu-id="db865-152">Recommendations</span></span>

<span data-ttu-id="db865-153">此体系结构描述一个小型的生产级企业部署。</span><span class="sxs-lookup"><span data-stu-id="db865-153">This architecture describes a small production-level enterprise deployment.</span></span> <span data-ttu-id="db865-154">部署根据业务要求的不同而异。</span><span class="sxs-lookup"><span data-stu-id="db865-154">Your deployment will differ based on your business requirements.</span></span> <span data-ttu-id="db865-155">请使用以下建议作为入手点。</span><span class="sxs-lookup"><span data-stu-id="db865-155">Use these recommendations as a starting point.</span></span>

### <a name="virtual-machines"></a><span data-ttu-id="db865-156">虚拟机</span><span class="sxs-lookup"><span data-stu-id="db865-156">Virtual machines</span></span>

<span data-ttu-id="db865-157">在应用程序服务器池和群集中，根据要求调整虚拟机数目。</span><span class="sxs-lookup"><span data-stu-id="db865-157">In application server pools and clusters, adjust the number of virtual machines based on your requirements.</span></span> <span data-ttu-id="db865-158">[Azure 虚拟机规划和实施指南](/azure/virtual-machines/workloads/sap/planning-guide)中包含了有关在虚拟机上运行 SAP NetWeaver 的详细信息，但这些信息同样适用于 SAP S/4HANA。</span><span class="sxs-lookup"><span data-stu-id="db865-158">The [Azure Virtual Machines planning and implementation guide](/azure/virtual-machines/workloads/sap/planning-guide) includes details about running SAP NetWeaver on virtual machines, but the information applies to SAP S/4HANA as well.</span></span>

<span data-ttu-id="db865-159">有关 SAP 支持的 Azure 虚拟机类型和吞吐量指标 (SAPS) 的详细信息，请参阅 [SAP 说明 1928533](https://launchpad.support.sap.com/#/notes/1928533)。</span><span class="sxs-lookup"><span data-stu-id="db865-159">For details about SAP support for Azure virtual machine types and throughput metrics (SAPS), see [SAP Note 1928533](https://launchpad.support.sap.com/#/notes/1928533).</span></span> 

### <a name="sap-web-dispatcher-pool"></a><span data-ttu-id="db865-160">SAP Web 调度程序池</span><span class="sxs-lookup"><span data-stu-id="db865-160">SAP Web Dispatcher pool</span></span>

<span data-ttu-id="db865-161">Web 调度程序组件用作 SAP 应用程序服务器之间的 SAP 流量的负载均衡器。</span><span class="sxs-lookup"><span data-stu-id="db865-161">The Web Dispatcher component is used as a load balancer for SAP traffic among the SAP application servers.</span></span> <span data-ttu-id="db865-162">为了实现 Web 调度程序组件的高可用性，在轮循机制配置中使用了 Azure 负载均衡器来实施并行 Web 调度程序设置，以便在均衡器后端池中的可用 Web 调度程序之间分配 HTTP(S) 流量。</span><span class="sxs-lookup"><span data-stu-id="db865-162">To achieve high availability for the Web Dispatcher component, Azure Load Balancer is used to implement the parallel Web Dispatcher setup in a round-robin configuration for HTTP(S) traffic distribution among the available Web Dispatchers in the balancers back-end pool.</span></span> 

### <a name="fiori-front-end-server"></a><span data-ttu-id="db865-163">Fiori 前端服务器</span><span class="sxs-lookup"><span data-stu-id="db865-163">Fiori Front-end Server</span></span>

<span data-ttu-id="db865-164">Fiori 前端服务器使用 [NetWeaver 网关](https://help.sap.com/doc/saphelp_gateway20sp12/2.0/en-US/76/08828d832e4aa78748e9f82204a864/content.htm?no_cache=true)。</span><span class="sxs-lookup"><span data-stu-id="db865-164">The Fiori Front-end Server uses a [NetWeaver Gateway](https://help.sap.com/doc/saphelp_gateway20sp12/2.0/en-US/76/08828d832e4aa78748e9f82204a864/content.htm?no_cache=true).</span></span> <span data-ttu-id="db865-165">对于小型部署，可以在 Fiori 服务器上加载该网关。</span><span class="sxs-lookup"><span data-stu-id="db865-165">For small deployments, it can be loaded on the Fiori server.</span></span> <span data-ttu-id="db865-166">对于大型部署，可将 NetWeaver 网关的独立服务器部署在 Fiori 前端服务器池的前面。</span><span class="sxs-lookup"><span data-stu-id="db865-166">For large deployments, a separate server for the NetWeaver Gateway may be deployed in front of the Fiori Front-end Server pool.</span></span>

### <a name="application-servers-pool"></a><span data-ttu-id="db865-167">应用程序服务器池</span><span class="sxs-lookup"><span data-stu-id="db865-167">Application servers pool</span></span>

<span data-ttu-id="db865-168">若要管理 ABAP 应用程序服务器的登录组，需使用 SMLG 事务。</span><span class="sxs-lookup"><span data-stu-id="db865-168">To manage logon groups for ABAP application servers, the SMLG transaction is used.</span></span> <span data-ttu-id="db865-169">该事务使用 Central Services 的消息服务器中的负载均衡功能，在 SAPGUI 的 SAP 应用程序服务器池之间分配工作负荷，以及分配 RFC 流量。</span><span class="sxs-lookup"><span data-stu-id="db865-169">It uses the load balancing function within the message server of the Central Services to distribute workload among SAP application servers pool for SAPGUIs and RFC traffic.</span></span> <span data-ttu-id="db865-170">与高可用性 Central Services 的应用程序服务器连接通过群集虚拟网络名称来建立。</span><span class="sxs-lookup"><span data-stu-id="db865-170">The application server connection to the highly available Central Services is through the cluster virtual network name.</span></span> <span data-ttu-id="db865-171">因此，在完成本地故障转移后，无需更改 Central Services 连接的应用程序服务器配置文件。</span><span class="sxs-lookup"><span data-stu-id="db865-171">This avoids the need to change the application server profile for Central Services connectivity after a local failover.</span></span> 

### <a name="sap-central-services-cluster"></a><span data-ttu-id="db865-172">SAP Central Services 群集</span><span class="sxs-lookup"><span data-stu-id="db865-172">SAP Central Services cluster</span></span>

<span data-ttu-id="db865-173">当高可用性不是一项要求时，可将 Central Services 部署到单个虚拟机。</span><span class="sxs-lookup"><span data-stu-id="db865-173">Central Services can be deployed to a single virtual machine when high availability is not a requirement.</span></span> <span data-ttu-id="db865-174">但是，单个虚拟机在 SAP 环境中会成为潜在的单一故障点 (SPOF)。</span><span class="sxs-lookup"><span data-stu-id="db865-174">However, the single virtual machine becomes a potential single point of failure (SPOF) for the SAP environment.</span></span> <span data-ttu-id="db865-175">对于高可用性 Central Services 部署，可以使用高可用性 NFS 群集和高可用性 Central Services 群集。</span><span class="sxs-lookup"><span data-stu-id="db865-175">For a highly available Central Services deployment, a highly available NFS cluster and a highly available Central Services cluster are used.</span></span>

### <a name="nfs-cluster"></a><span data-ttu-id="db865-176">NFS 群集</span><span class="sxs-lookup"><span data-stu-id="db865-176">NFS cluster</span></span>

<span data-ttu-id="db865-177">DRBD（分布式复制块设备）用于在 NFS 群集的节点之间复制。</span><span class="sxs-lookup"><span data-stu-id="db865-177">DRBD (Distributed Replicated Block Device) is used for replication between the nodes of the NFS cluster.</span></span>

### <a name="availability-sets"></a><span data-ttu-id="db865-178">可用性集</span><span class="sxs-lookup"><span data-stu-id="db865-178">Availability sets</span></span>

<span data-ttu-id="db865-179">可用性集将服务器分配到不同的物理基础结构，并更新组以提高服务可用性。</span><span class="sxs-lookup"><span data-stu-id="db865-179">Availability sets distribute servers to different physical infrastructure and update groups to improve service availability.</span></span> <span data-ttu-id="db865-180">将执行相同角色的虚拟机放入某个可用性集有助于避免 Azure 基础结构维护工作造成的停机，并有助于满足 [SLA](https://azure.microsoft.com/support/legal/sla/virtual-machines)。</span><span class="sxs-lookup"><span data-stu-id="db865-180">Put virtual machines that perform the same role into an availability sets to help guard against downtime caused by Azure infrastructure maintenance and to meet [SLAs](https://azure.microsoft.com/support/legal/sla/virtual-machines).</span></span> <span data-ttu-id="db865-181">建议为每个可用性集配置两个或更多个虚拟机。</span><span class="sxs-lookup"><span data-stu-id="db865-181">Two or more virtual machines per availability set is recommended.</span></span>

<span data-ttu-id="db865-182">一个集内的所有虚拟机必须执行相同的角色。</span><span class="sxs-lookup"><span data-stu-id="db865-182">All virtual machines in a set must perform the same role.</span></span> <span data-ttu-id="db865-183">不要在同一个可用性集中混合不同角色的服务器。</span><span class="sxs-lookup"><span data-stu-id="db865-183">Do not mix servers of different roles in the same availability set.</span></span> <span data-ttu-id="db865-184">例如，不要将 ASCS 节点放到应用程序服务器所在的同一个可用性集中。</span><span class="sxs-lookup"><span data-stu-id="db865-184">For example, don't place a ASCS node in the same availability set with the application server.</span></span>

### <a name="nics"></a><span data-ttu-id="db865-185">NIC</span><span class="sxs-lookup"><span data-stu-id="db865-185">NICs</span></span>

<span data-ttu-id="db865-186">传统的本地 SAP 布局为每个计算机实施多个网络接口卡 (NIC)，以便将管理流量与业务流量相分离。</span><span class="sxs-lookup"><span data-stu-id="db865-186">Traditional on-premises SAP landscapes implement multiple network interface cards (NICs) per machine to segregate administrative traffic from business traffic.</span></span> <span data-ttu-id="db865-187">在 Azure 上，虚拟网络是软件定义的网络，它通过同一网络结构发送所有流量。</span><span class="sxs-lookup"><span data-stu-id="db865-187">On Azure, the virtual network is a software-defined network that sends all traffic through the same network fabric.</span></span> <span data-ttu-id="db865-188">因此，没有必要使用多个 NIC。</span><span class="sxs-lookup"><span data-stu-id="db865-188">Therefore, the use of multiple NICs is unnecessary.</span></span> <span data-ttu-id="db865-189">但是，如果组织需要分离流量，则可为每个 VM 部署多个 NIC，将每个 NIC 连接到不同的子网，然后使用 NSG 强制实施不同的访问控制策略。</span><span class="sxs-lookup"><span data-stu-id="db865-189">However, if your organization needs to segregate traffic, you can deploy multiple NICs per VM, connect each NIC to a different subnet, and then use NSGs to enforce different access control policies.</span></span>

### <a name="subnets-and-nsgs"></a><span data-ttu-id="db865-190">子网和 NSG</span><span class="sxs-lookup"><span data-stu-id="db865-190">Subnets and NSGs</span></span>

<span data-ttu-id="db865-191">此体系结构将虚拟网络地址空间划分为子网。</span><span class="sxs-lookup"><span data-stu-id="db865-191">This architecture subdivides the virtual network address space into subnets.</span></span> <span data-ttu-id="db865-192">每个子网可与定义子网访问策略的 NSG 相关联。</span><span class="sxs-lookup"><span data-stu-id="db865-192">Each subnet can be associated with a NSG that defines the access policies for the subnet.</span></span> <span data-ttu-id="db865-193">请将应用程序服务器放在单独的子网中，以便可以通过管理子网安全策略而不是单个服务器，更轻松地为服务器提供保护。</span><span class="sxs-lookup"><span data-stu-id="db865-193">Place application servers on a separate subnet so you can secure them more easily by managing the subnet security policies, not the individual servers.</span></span>

<span data-ttu-id="db865-194">NSG 在与某个子网关联后，将应用到该子网中的所有服务器。</span><span class="sxs-lookup"><span data-stu-id="db865-194">When a NSG is associated with a subnet, it then applies to all the servers within the subnet.</span></span> <span data-ttu-id="db865-195">有关使用 NSG 对子网中的服务器进行精细控制的详细信息，请参阅[使用网络安全组筛选网络流量](https://azure.microsoft.com/blog/multiple-vm-nics-and-network-virtual-appliances-in-azure/)。</span><span class="sxs-lookup"><span data-stu-id="db865-195">For more information about using NSGs for fine-grained control over the servers in a subnet, see [Filter network traffic with network security groups](https://azure.microsoft.com/blog/multiple-vm-nics-and-network-virtual-appliances-in-azure/).</span></span>

<span data-ttu-id="db865-196">另请参阅[规划和设计 VPN 网关](/azure/vpn-gateway/vpn-gateway-plan-design)。</span><span class="sxs-lookup"><span data-stu-id="db865-196">See also [Planning and design for VPN Gateway](/azure/vpn-gateway/vpn-gateway-plan-design).</span></span>

### <a name="load-balancers"></a><span data-ttu-id="db865-197">负载均衡器</span><span class="sxs-lookup"><span data-stu-id="db865-197">Load balancers</span></span>

<span data-ttu-id="db865-198">[SAP Web 调度程序](https://help.sap.com/doc/saphelp_nw73ehp1/7.31.19/en-US/48/8fe37933114e6fe10000000a421937/frameset.htm)处理 HTTP(S) 流量的负载均衡（包括 Fiori 式应用程序发往 SAP 应用程序服务器池的流量）。</span><span class="sxs-lookup"><span data-stu-id="db865-198">[SAP Web Dispatcher](https://help.sap.com/doc/saphelp_nw73ehp1/7.31.19/en-US/48/8fe37933114e6fe10000000a421937/frameset.htm) handles load balancing of HTTP(S) traffic including Fiori style applications to a pool of SAP application servers.</span></span> 

<span data-ttu-id="db865-199">对于通过 DIAG 或远程函数调用 (RFC) 连接 SAP 服务器的 SAP GUI 客户端发出的流量，Central Service 消息服务器会通过 SAP 应用程序服务器[登录组](https://wiki.scn.sap.com/wiki/display/SI/ABAP+Logon+Group+based+Load+Balancing)进行负载均衡，因此，无需额外的负载均衡器。</span><span class="sxs-lookup"><span data-stu-id="db865-199">For traffic from SAP GUI clients connecting a SAP server via DIAG or Remote Function Calls (RFC), the Central Service message server balances the load through SAP application server [logon groups](https://wiki.scn.sap.com/wiki/display/SI/ABAP+Logon+Group+based+Load+Balancing), so no additional load balancer is needed.</span></span> 

### <a name="azure-storage"></a><span data-ttu-id="db865-200">Azure 存储</span><span class="sxs-lookup"><span data-stu-id="db865-200">Azure Storage</span></span>

<span data-ttu-id="db865-201">对于数据库服务器虚拟机，我们建议使用 Azure 高级存储。</span><span class="sxs-lookup"><span data-stu-id="db865-201">We recommend using Azure Premium Storage for the database server virtual machines.</span></span> <span data-ttu-id="db865-202">高级存储提供一致的读/写延迟。</span><span class="sxs-lookup"><span data-stu-id="db865-202">Premium storage provides consistent read/write latency.</span></span> <span data-ttu-id="db865-203">有关对单一实例虚拟机的操作系统磁盘和数据磁盘使用高级存储的详细信息，请参阅[虚拟机的 SLA](https://azure.microsoft.com/support/legal/sla/virtual-machines/)。</span><span class="sxs-lookup"><span data-stu-id="db865-203">For details about using Premium Storage for the operating system disks and data disks of a single-instance virtual machine, see [SLA for Virtual Machines](https://azure.microsoft.com/support/legal/sla/virtual-machines/).</span></span> 

<span data-ttu-id="db865-204">对于所有 SAP 生产系统，我们建议使用高级 [Azure 托管磁盘](/azure/storage/storage-managed-disks-overview)。</span><span class="sxs-lookup"><span data-stu-id="db865-204">For all production SAP systems, we recommend using Premium [Azure Managed Disks](/azure/storage/storage-managed-disks-overview).</span></span> <span data-ttu-id="db865-205">托管磁盘用于管理磁盘的 VHD 文件，以提高可靠性。</span><span class="sxs-lookup"><span data-stu-id="db865-205">Managed Disks are used to manage the VHD files for the disks, adding reliability.</span></span> <span data-ttu-id="db865-206">托管磁盘还可确保隔离可用性集中虚拟机的磁盘，以避免单一故障点。</span><span class="sxs-lookup"><span data-stu-id="db865-206">They also ensure that the disks for virtual machines within an availability set are isolated to avoid single points of failure.</span></span>

<span data-ttu-id="db865-207">对于 SAP 应用程序服务器，包括 Central Services 虚拟机，可以使用标准 Azure 存储来降低成本，因为应用程序执行在内存中发生，只将磁盘用于日志记录。</span><span class="sxs-lookup"><span data-stu-id="db865-207">For SAP application servers, including the Central Services virtual machines, you can use Azure Standard Storage to reduce cost, because application execution takes place in memory and uses disks for logging only.</span></span> <span data-ttu-id="db865-208">但是，目前只有标准存储才通过了非托管存储的认证。</span><span class="sxs-lookup"><span data-stu-id="db865-208">However, at this time, Standard Storage is only certified for unmanaged storage.</span></span> <span data-ttu-id="db865-209">由于应用程序服务器不会托管任何数据，因此你可以借助较小的 P4 和 P6 高级存储磁盘来尽量降低成本。</span><span class="sxs-lookup"><span data-stu-id="db865-209">Since application servers do not host any data, you can also use the smaller P4 and P6 Premium Storage disks to help minimize cost.</span></span>

<span data-ttu-id="db865-210">对于备份数据存储，我们建议使用 Azure [冷访问层存储和/或存档访问层存储](/azure/storage/storage-blob-storage-tiers)。</span><span class="sxs-lookup"><span data-stu-id="db865-210">For the backup data store, we recommend using Azure [cool access tier storage and/or archive access tier storage](/azure/storage/storage-blob-storage-tiers).</span></span> <span data-ttu-id="db865-211">这些存储层的性价比较高，适合用于存储不经常访问的长久留存数据。</span><span class="sxs-lookup"><span data-stu-id="db865-211">These storage tiers are cost-effective ways to store long-lived data that is less frequently accessed.</span></span>

## <a name="performance-considerations"></a><span data-ttu-id="db865-212">性能注意事项</span><span class="sxs-lookup"><span data-stu-id="db865-212">Performance considerations</span></span>

<span data-ttu-id="db865-213">SAP 应用程序服务器与数据库服务器不断通信。</span><span class="sxs-lookup"><span data-stu-id="db865-213">SAP application servers carry on constant communications with the database servers.</span></span> <span data-ttu-id="db865-214">对于 HANA 数据库虚拟机，请考虑启用[写入加速器](/azure/virtual-machines/linux/how-to-enable-write-accelerator)来改善日志写入延迟。</span><span class="sxs-lookup"><span data-stu-id="db865-214">For the HANA database virtual machines, consider enabling [Write Accelerator](/azure/virtual-machines/linux/how-to-enable-write-accelerator) to improve log write latency.</span></span> <span data-ttu-id="db865-215">若要优化服务器间的通信，请使用[加速网络](https://azure.microsoft.com/blog/linux-and-windows-networking-performance-enhancements-accelerated-networking/)。</span><span class="sxs-lookup"><span data-stu-id="db865-215">To optimize inter-server communications, use the [Accelerated Network](https://azure.microsoft.com/blog/linux-and-windows-networking-performance-enhancements-accelerated-networking/).</span></span> <span data-ttu-id="db865-216">请注意，这些加速器仅适用于某些 VM 系列。</span><span class="sxs-lookup"><span data-stu-id="db865-216">Note that these accelerators are available only for certain VM series.</span></span>

<span data-ttu-id="db865-217">若要实现较高的 IOPS 和磁盘带宽吞吐量，可向 Azure 存储布局应用[优化存储卷性能](/azure/virtual-machines/linux/premium-storage-performance)时采用的常见做法。</span><span class="sxs-lookup"><span data-stu-id="db865-217">To achieve high IOPS and disk bandwidth throughput, the common practices in storage volume [performance optimization](/azure/virtual-machines/linux/premium-storage-performance) apply to Azure storage layout.</span></span> <span data-ttu-id="db865-218">例如，将多个磁盘合并在一起以创建条带化磁盘卷可以提高 IO 性能。</span><span class="sxs-lookup"><span data-stu-id="db865-218">For example, combining multiple disks together to create a striped disk volume improves IO performance.</span></span> <span data-ttu-id="db865-219">针对不经常更改的存储内容启用读取缓存可增强数据检索的速度。</span><span class="sxs-lookup"><span data-stu-id="db865-219">Enabling the read cache on storage content that changes infrequently enhances the speed of data retrieval.</span></span> <span data-ttu-id="db865-220">有关性能要求的详细信息，请参阅 [SAP 说明 1943937 - 硬件配置检查工具](https://launchpad.support.sap.com/#/notes/1943937)（需要创建 SAP Service Marketplace 帐户进行访问）。</span><span class="sxs-lookup"><span data-stu-id="db865-220">For details about performance requirements, see [SAP note 1943937 - Hardware Configuration Check Tool](https://launchpad.support.sap.com/#/notes/1943937) (SAP Service Marketplace account required for access).</span></span>

## <a name="scalability-considerations"></a><span data-ttu-id="db865-221">可伸缩性注意事项</span><span class="sxs-lookup"><span data-stu-id="db865-221">Scalability considerations</span></span>

<span data-ttu-id="db865-222">在 SAP 应用程序层，Azure 提供多种虚拟机大小供纵向和横向扩展。有关详尽列表，请参阅 [SAP 说明 1928533](https://launchpad.support.sap.com/#/notes/1928533) - Azure 上的 SAP 应用程序：支持的产品和 Azure VM 类型（需要创建 SAP Service Marketplace 帐户进行访问）。</span><span class="sxs-lookup"><span data-stu-id="db865-222">At the SAP application layer, Azure offers a wide range of virtual machine sizes for scaling up and scaling out. For an inclusive list, see [SAP Note 1928533](https://launchpad.support.sap.com/#/notes/1928533) - SAP Applications on Azure: Supported Products and Azure VM types (SAP Service Marketplace account required for access).</span></span> <span data-ttu-id="db865-223">随着我们不断地认证更多的虚拟机类型，你可以在同一个云部署中进行纵向扩展或缩减。</span><span class="sxs-lookup"><span data-stu-id="db865-223">As we continue to certify more virtual machines types, you can scale up or down with the same cloud deployment.</span></span> 

<span data-ttu-id="db865-224">在数据库层中，此体系结构在 VM 上运行 HANA。</span><span class="sxs-lookup"><span data-stu-id="db865-224">At the database layer, this architecture runs HANA on VMs.</span></span> <span data-ttu-id="db865-225">如果工作负荷超过了最大 VM 大小，Microsoft 还为 SAP HANA 提供 [Azure 大型实例](/azure/virtual-machines/workloads/sap/hana-overview-architecture)。</span><span class="sxs-lookup"><span data-stu-id="db865-225">If your workload exceeds the maximum VM size, Microsoft also offers [Azure Large Instances](/azure/virtual-machines/workloads/sap/hana-overview-architecture) for SAP HANA.</span></span> <span data-ttu-id="db865-226">这些物理服务器共置在 Microsoft Azure 认证的数据中心，截至本文发布时，最多为单个实例提供 20 TB 的内存容量。</span><span class="sxs-lookup"><span data-stu-id="db865-226">These physical servers are co-located in a Microsoft Azure certified datacenter and as of this writing, provide up to 20 TB of memory capacity for a single instance.</span></span> <span data-ttu-id="db865-227">凭借多达 60 TB 的总内存容量，还可以实现多节点配置。</span><span class="sxs-lookup"><span data-stu-id="db865-227">Multi-node configuration is also possible with a total memory capacity of up to 60 TB.</span></span>

## <a name="availability-considerations"></a><span data-ttu-id="db865-228">可用性注意事项</span><span class="sxs-lookup"><span data-stu-id="db865-228">Availability considerations</span></span>

<span data-ttu-id="db865-229">资源冗余是高可用性基础结构解决方案中的常见话题。</span><span class="sxs-lookup"><span data-stu-id="db865-229">Resource redundancy is the general theme in highly available infrastructure solutions.</span></span> <span data-ttu-id="db865-230">对于 SLA 不太苛刻的组织而言，单一实例 Azure VM 可以保障运行时间 SLA。</span><span class="sxs-lookup"><span data-stu-id="db865-230">For enterprises that have a less stringent SLA, single-instance Azure VMs offer an uptime SLA.</span></span> <span data-ttu-id="db865-231">有关详细信息，请参阅 [Azure 服务级别协议](https://azure.microsoft.com/support/legal/sla/)。</span><span class="sxs-lookup"><span data-stu-id="db865-231">For more information, see [Azure Service Level Agreement](https://azure.microsoft.com/support/legal/sla/).</span></span>

<span data-ttu-id="db865-232">在这种 SAP 应用程序分布式安装中，将会复制基本安装以实现高可用性。</span><span class="sxs-lookup"><span data-stu-id="db865-232">In this distributed installation of the SAP application, the base installation is replicated to achieve high availability.</span></span> <span data-ttu-id="db865-233">对于体系结构的每个层，高可用性设计各不相同。</span><span class="sxs-lookup"><span data-stu-id="db865-233">For each layer of the architecture, the high availability design varies.</span></span> 

### <a name="application-tier"></a><span data-ttu-id="db865-234">应用层</span><span class="sxs-lookup"><span data-stu-id="db865-234">Application tier</span></span>

- <span data-ttu-id="db865-235">Web 调度程序。</span><span class="sxs-lookup"><span data-stu-id="db865-235">Web Dispatcher.</span></span> <span data-ttu-id="db865-236">高可用性是通过冗余的 Web 调度程序实例实现的。</span><span class="sxs-lookup"><span data-stu-id="db865-236">High availability is achieved with redundant Web Dispatcher instances.</span></span> <span data-ttu-id="db865-237">请参阅 SAP 文档中的 [SAP Web 调度程序](https://help.sap.com/doc/saphelp_nw70ehp2/7.02.16/en-us/48/8fe37933114e6fe10000000a421937/frameset.htm)。</span><span class="sxs-lookup"><span data-stu-id="db865-237">See [SAP Web Dispatcher](https://help.sap.com/doc/saphelp_nw70ehp2/7.02.16/en-us/48/8fe37933114e6fe10000000a421937/frameset.htm) in the SAP documentation.</span></span>
- <span data-ttu-id="db865-238">Fiori 服务器。</span><span class="sxs-lookup"><span data-stu-id="db865-238">Fiori servers.</span></span> <span data-ttu-id="db865-239">高可用性是通过对服务器池中的流量进行负载均衡实现的。</span><span class="sxs-lookup"><span data-stu-id="db865-239">High availability is achieved by load balancing traffic within a pool of servers.</span></span>
- <span data-ttu-id="db865-240">Central Services。</span><span class="sxs-lookup"><span data-stu-id="db865-240">Central Services.</span></span> <span data-ttu-id="db865-241">为实现 Azure Linux 虚拟机上 Central Services 的高可用性，使用了所选 Linux 分发版的相应高可用性扩展；高可用性 NFS 群集托管 DRBD 存储。</span><span class="sxs-lookup"><span data-stu-id="db865-241">For high availability of Central Services on Azure Linux virtual machines, the appropriate High Availability Extension for the selected Linux distribution is used, and the highly available NFS cluster hosts DRBD storage.</span></span>
- <span data-ttu-id="db865-242">应用程序服务器。</span><span class="sxs-lookup"><span data-stu-id="db865-242">Application servers.</span></span> <span data-ttu-id="db865-243">可通过对应用程序服务器池中的流量进行负载均衡来实现高可用性。</span><span class="sxs-lookup"><span data-stu-id="db865-243">High availability is achieved by load balancing traffic within a pool of application servers.</span></span>

### <a name="database-tier"></a><span data-ttu-id="db865-244">数据库层</span><span class="sxs-lookup"><span data-stu-id="db865-244">Database tier</span></span>

<span data-ttu-id="db865-245">此参考体系结构描述包括两个 Azure 虚拟机的高可用性 SAP HANA 数据库系统。</span><span class="sxs-lookup"><span data-stu-id="db865-245">This reference architecture depicts a highly available SAP HANA database system consisting of two Azure virtual machines.</span></span> <span data-ttu-id="db865-246">数据库层的本机系统复制功能在复制的节点之间提供手动或自动故障转移。</span><span class="sxs-lookup"><span data-stu-id="db865-246">The database tier's native system replication feature provides either manual or automatic failover between replicated nodes:</span></span>

- <span data-ttu-id="db865-247">若要手动故障转移，请部署多个实例，并使用 HANA 系统复制 (HSR)。</span><span class="sxs-lookup"><span data-stu-id="db865-247">For manual failover, deploy more than one HANA instance and use HANA System Replication (HSR).</span></span>
- <span data-ttu-id="db865-248">若要自动故障转移，请使用适用于 Linux 分发版的 HSR 和 Linux 高可用性扩展 (HAE)。</span><span class="sxs-lookup"><span data-stu-id="db865-248">For automatic failover, use both HSR and Linux High Availability Extension (HAE) for your Linux distribution.</span></span> <span data-ttu-id="db865-249">Linux HAE 为 HANA 资源提供群集服务、检测故障事件，并协调将出错服务故障转移到正常节点的过程。</span><span class="sxs-lookup"><span data-stu-id="db865-249">Linux HAE provides the cluster services to the HANA resources, detecting failure events and orchestrating the failover of errant services to the healthy node.</span></span> 

<span data-ttu-id="db865-250">请参阅[在 Microsoft Azure 上运行的 SAP 认证和配置](/azure/virtual-machines/workloads/sap/sap-certifications)。</span><span class="sxs-lookup"><span data-stu-id="db865-250">See [SAP certifications and configurations running on Microsoft Azure](/azure/virtual-machines/workloads/sap/sap-certifications).</span></span>

### <a name="disaster-recovery-considerations"></a><span data-ttu-id="db865-251">灾难恢复注意事项</span><span class="sxs-lookup"><span data-stu-id="db865-251">Disaster recovery considerations</span></span>
<span data-ttu-id="db865-252">每个层使用不同的策略提供灾难恢复 (DR) 保护。</span><span class="sxs-lookup"><span data-stu-id="db865-252">Each tier uses a different strategy to provide disaster recovery (DR) protection.</span></span>

- <span data-ttu-id="db865-253">**应用程序服务器层**。</span><span class="sxs-lookup"><span data-stu-id="db865-253">**Application servers tier**.</span></span> <span data-ttu-id="db865-254">SAP 应用程序服务器不包含业务数据。</span><span class="sxs-lookup"><span data-stu-id="db865-254">SAP application servers do not contain business data.</span></span> <span data-ttu-id="db865-255">在 Azure 上，简单的 DR 策略是在次要区域中创建 SAP 应用程序服务器，然后关闭这些服务器。</span><span class="sxs-lookup"><span data-stu-id="db865-255">On Azure, a simple DR strategy is to create SAP application servers in the secondary region, then shut them down.</span></span> <span data-ttu-id="db865-256">在主要应用程序服务器上进行任何配置更改或内核更新后，必须将相同的更改应用到次要区域中的虚拟机。</span><span class="sxs-lookup"><span data-stu-id="db865-256">Upon any configuration changes or kernel updates on the primary application server, the same changes must be applied to the virtual machines in the secondary region.</span></span> <span data-ttu-id="db865-257">例如，将 SAP 内核可执行文件复制到 DR 虚拟机。</span><span class="sxs-lookup"><span data-stu-id="db865-257">For example, copy the SAP kernel executables to the DR virtual machines.</span></span> <span data-ttu-id="db865-258">要将应用程序服务器自动复制到次要区域，建议使用 [Azure Site Recovery](/azure/site-recovery/site-recovery-overview) 解决方案。</span><span class="sxs-lookup"><span data-stu-id="db865-258">For automatic replication of application servers to a secondary region, [Azure Site Recovery](/azure/site-recovery/site-recovery-overview) is the recommended solution.</span></span> <span data-ttu-id="db865-259">截至本文编写时，ASR 尚不支持复制 Azure VM 中的加速网络配置设置。</span><span class="sxs-lookup"><span data-stu-id="db865-259">As of the writing of this paper, ASR doesn't yet support the replication of the Accelerated Network configuration setting in Azure VMs.</span></span>

- <span data-ttu-id="db865-260">**Central Services**。</span><span class="sxs-lookup"><span data-stu-id="db865-260">**Central Services**.</span></span> <span data-ttu-id="db865-261">SAP 应用程序堆栈的此组件也不会保存业务数据。</span><span class="sxs-lookup"><span data-stu-id="db865-261">This component of the SAP application stack also does not persist business data.</span></span> <span data-ttu-id="db865-262">可以在次要区域中构建一个 VM 来运行 Central Services 角色。</span><span class="sxs-lookup"><span data-stu-id="db865-262">You can build a VM in the secondary region to run the Central Services role.</span></span> <span data-ttu-id="db865-263">在主要 Central Services 节点中，要同步的唯一内容是 /sapmnt 共享内容。</span><span class="sxs-lookup"><span data-stu-id="db865-263">The only content from the primary Central Services node to synchronize is the /sapmnt share content.</span></span> <span data-ttu-id="db865-264">此外，如果主要 Central Services 服务器上发生配置更改或内核更新，必须在次要区域中运行 Central Services 的 VM 上重复这些操作。</span><span class="sxs-lookup"><span data-stu-id="db865-264">Also, if configuration changes or kernel updates take place on the primary Central Services servers, they must be repeated on the VM in the secondary region running Central Services.</span></span> <span data-ttu-id="db865-265">若要同步两个服务器，可以使用 Azure Site Recovery 复制群集节点，或只需使用定期计划的复制作业将 /sapmnt 复制到 DR 端。</span><span class="sxs-lookup"><span data-stu-id="db865-265">To synchronize the two servers, you can use either Azure Site Recovery, to replicate the cluster nodes, or simply use a regularly scheduled copy job to copy /sapmnt to the DR side.</span></span> <span data-ttu-id="db865-266">有关生成、复制和测试故障转移过程的详细信息，请下载[ SAP NetWeaver：生成基于 Hyper-V 和 Microsoft Azure 的灾难恢复解决方案](https://download.microsoft.com/download/9/5/6/956FEDC3-702D-4EFB-A7D3-2DB7505566B6/SAP%20NetWeaver%20-%20Building%20an%20Azure%20based%20Disaster%20Recovery%20Solution%20V1_5%20.docx)，并参阅第 4.3 部分“SAP SPOF 层 (ASCS)”。</span><span class="sxs-lookup"><span data-stu-id="db865-266">For details about the build, copy, and test failover process, download [SAP NetWeaver: Building a Hyper-V and Microsoft Azure–based Disaster Recovery Solution](https://download.microsoft.com/download/9/5/6/956FEDC3-702D-4EFB-A7D3-2DB7505566B6/SAP%20NetWeaver%20-%20Building%20an%20Azure%20based%20Disaster%20Recovery%20Solution%20V1_5%20.docx), and refer to section 4.3, "SAP SPOF layer (ASCS)."</span></span> <span data-ttu-id="db865-267">此文章适用于 Windows 上运行的 NetWeaver，但可为 Linux 创建等效的配置。</span><span class="sxs-lookup"><span data-stu-id="db865-267">This paper applies to NetWeaver running on Windows, but you can create the equivalent configuration for Linux.</span></span> <span data-ttu-id="db865-268">对于 Central Services，请使用 [Azure Site Recovery](/en-us/azure/site-recovery/site-recovery-overview) 来复制群集节点和存储。</span><span class="sxs-lookup"><span data-stu-id="db865-268">For Central Services, use [Azure Site Recovery](/en-us/azure/site-recovery/site-recovery-overview) to replicate the cluster nodes and storage.</span></span> <span data-ttu-id="db865-269">对于 Linux，请使用高可用性扩展创建三节点地理群集。</span><span class="sxs-lookup"><span data-stu-id="db865-269">For Linux, create a three node geo-cluster using a High Availability Extension.</span></span> 

- <span data-ttu-id="db865-270">**SAP 数据库层**。</span><span class="sxs-lookup"><span data-stu-id="db865-270">**SAP database tier**.</span></span> <span data-ttu-id="db865-271">使用 HSR 执行 HANA 支持的复制。</span><span class="sxs-lookup"><span data-stu-id="db865-271">Use HSR for HANA-supported replication.</span></span> <span data-ttu-id="db865-272">除了本地的双节点高可用性设置以外，HSR 还支持多层复制，其中，独立 Azure 区域中的第三个节点充当外部实体而不是群集的一部分，它会注册到 HSR 群集对的辅助副本（复制目标）。</span><span class="sxs-lookup"><span data-stu-id="db865-272">In addition to a local, two-node high availability setup, HSR supports multi-tier replication where a third node in a separate Azure region acts as a foreign entity, not part of the cluster, and registers to the secondary replica of the clustered HSR pair as its replication target.</span></span> <span data-ttu-id="db865-273">这就构成了复制菊花链。</span><span class="sxs-lookup"><span data-stu-id="db865-273">This form a replication daisy chain.</span></span> <span data-ttu-id="db865-274">故障转移到 DR 节点是一个手动过程。</span><span class="sxs-lookup"><span data-stu-id="db865-274">The failover to the DR node is a manual process.</span></span>

<span data-ttu-id="db865-275">若要使用 Azure Site Recovery 自动构建原始站点的完整复制生产站点，必须运行自定义的[部署脚本](/azure/site-recovery/site-recovery-runbook-automation)。</span><span class="sxs-lookup"><span data-stu-id="db865-275">To use Azure Site Recovery to automatically build a fully replicated production site of your original, you must run customized [deployment scripts](/azure/site-recovery/site-recovery-runbook-automation).</span></span> <span data-ttu-id="db865-276">Site Recovery 首先在可用性集中部署虚拟机，然后运行脚本来添加负载均衡器等资源。</span><span class="sxs-lookup"><span data-stu-id="db865-276">Site Recovery first deploys the virtual machines in availability sets, then runs scripts to add resources such as load balancers.</span></span> 

## <a name="manageability-considerations"></a><span data-ttu-id="db865-277">可管理性注意事项</span><span class="sxs-lookup"><span data-stu-id="db865-277">Manageability considerations</span></span>

<span data-ttu-id="db865-278">SAP HANA 提供一个使用底层 Azure 基础结构的备份功能。</span><span class="sxs-lookup"><span data-stu-id="db865-278">SAP HANA has a backup feature that makes use of the underlying Azure infrastructure.</span></span> <span data-ttu-id="db865-279">若要备份 Azure 虚拟机上运行的 SAP HANA 数据库，可同时使用 SAP HANA 快照和 Azure 存储快照，以确保备份文件的一致性。</span><span class="sxs-lookup"><span data-stu-id="db865-279">To back up the SAP HANA database running on Azure virtual machines, both the SAP HANA snapshot and Azure storage snapshot are used to ensure the backup files' consistency.</span></span> <span data-ttu-id="db865-280">有关详细信息，请参阅 [Azure 虚拟机上的 SAP HANA 备份指南](/azure/virtual-machines/workloads/sap/sap-hana-backup-guide)和 [Azure 备份服务常见问题解答](/azure/backup/backup-azure-backup-faq)。</span><span class="sxs-lookup"><span data-stu-id="db865-280">For details, see [Backup guide for SAP HANA on Azure Virtual Machines](/azure/virtual-machines/workloads/sap/sap-hana-backup-guide) and the [Azure Backup service FAQ](/azure/backup/backup-azure-backup-faq).</span></span> <span data-ttu-id="db865-281">只有 HANA 单容器部署支持 Azure 存储快照。</span><span class="sxs-lookup"><span data-stu-id="db865-281">Only HANA single container deployments support Azure storage snapshot.</span></span>

### <a name="identity-management"></a><span data-ttu-id="db865-282">身份管理</span><span class="sxs-lookup"><span data-stu-id="db865-282">Identity management</span></span>

<span data-ttu-id="db865-283">在所有级别上使用集中式标识管理系统来控制对资源的访问：</span><span class="sxs-lookup"><span data-stu-id="db865-283">Control access to resources by using a centralized identity management system at all levels:</span></span>

- <span data-ttu-id="db865-284">通过[基于角色的访问控制](/azure/active-directory/role-based-access-control-what-is) (RBAC) 提供对 Azure 资源的访问。</span><span class="sxs-lookup"><span data-stu-id="db865-284">Provide access to Azure resources through [role-based access control](/azure/active-directory/role-based-access-control-what-is) (RBAC).</span></span> 
- <span data-ttu-id="db865-285">通过 LDAP、Azure Active Directory、Kerberos 或其他系统授予 Azure VM 的访问权限。</span><span class="sxs-lookup"><span data-stu-id="db865-285">Grant access to Azure VMs through LDAP, Azure Active Directory, Kerberos, or another system.</span></span> 
- <span data-ttu-id="db865-286">通过 SAP 提供的服务或使用 [OAuth 2.0 和 Azure Active Directory](/azure/active-directory/develop/active-directory-protocols-oauth-code)，在应用本身内部支持访问。</span><span class="sxs-lookup"><span data-stu-id="db865-286">Support access within the apps themselves through the services that SAP provides, or use [OAuth 2.0 and Azure Active Directory](/azure/active-directory/develop/active-directory-protocols-oauth-code).</span></span> 

### <a name="monitoring"></a><span data-ttu-id="db865-287">监视</span><span class="sxs-lookup"><span data-stu-id="db865-287">Monitoring</span></span>

<span data-ttu-id="db865-288">Azure 提供多种功能用于[监视和诊断](/azure/architecture/best-practices/monitoring)整个基础结构。</span><span class="sxs-lookup"><span data-stu-id="db865-288">Azure provides several functions for [monitoring and diagnostics](/azure/architecture/best-practices/monitoring) of the overall infrastructure.</span></span> <span data-ttu-id="db865-289">此外，Azure Operations Management Suite (OMS) 可处理 Azure 虚拟机（Linux 或 Windows）的增强型监视。</span><span class="sxs-lookup"><span data-stu-id="db865-289">Also, enhanced monitoring of Azure virtual machines (Linux or Windows) is handled by Azure Operations Management Suite (OMS).</span></span> 

<span data-ttu-id="db865-290">若要针对 SAP 基础结构的资源和服务性能提供基于 SAP 的监视，可使用 [Azure SAP 增强型监视](/azure/virtual-machines/workloads/sap/deployment-guide#d98edcd3-f2a1-49f7-b26a-07448ceb60ca)扩展。</span><span class="sxs-lookup"><span data-stu-id="db865-290">To provide SAP-based monitoring of resources and service performance of the SAP infrastructure, the [Azure SAP Enhanced Monitoring](/azure/virtual-machines/workloads/sap/deployment-guide#d98edcd3-f2a1-49f7-b26a-07448ceb60ca) extension is used.</span></span> <span data-ttu-id="db865-291">此扩展会将 Azure 监视统计信息馈送到 SAP 应用程序，以执行操作系统监视和 DBA Cockpit 功能。</span><span class="sxs-lookup"><span data-stu-id="db865-291">This extension feeds Azure monitoring statistics into the SAP application for operating system monitoring and DBA Cockpit functions.</span></span> <span data-ttu-id="db865-292">SAP 增强型监视是在 Azure 上运行 SAP 的必要先决条件。</span><span class="sxs-lookup"><span data-stu-id="db865-292">SAP enhanced monitoring is a mandatory prerequisite to run SAP on Azure.</span></span> <span data-ttu-id="db865-293">有关详细信息，请参阅 [SAP 说明 2191498](https://launchpad.support.sap.com/#/notes/2191498) –“Azure 上的 Linux 版 SAP：增强型监视”。</span><span class="sxs-lookup"><span data-stu-id="db865-293">For details, see [SAP Note 2191498](https://launchpad.support.sap.com/#/notes/2191498) – "SAP on Linux with Azure: Enhanced Monitoring."</span></span>

## <a name="security-considerations"></a><span data-ttu-id="db865-294">安全注意事项</span><span class="sxs-lookup"><span data-stu-id="db865-294">Security considerations</span></span>

<span data-ttu-id="db865-295">SAP 具有自身的用户管理引擎 (UME)，可在 SAP 应用程序中控制基于角色的访问和授权。</span><span class="sxs-lookup"><span data-stu-id="db865-295">SAP has its own Users Management Engine (UME) to control role-based access and authorization within the SAP application.</span></span> <span data-ttu-id="db865-296">有关详细信息，请参阅 [SAP HANA 安全性 - 概述](https://archive.sap.com/documents/docs/DOC-62943)（需要创建 SAP Service Marketplace 帐户进行访问。）</span><span class="sxs-lookup"><span data-stu-id="db865-296">For details, see [SAP HANA Security—An Overview](https://archive.sap.com/documents/docs/DOC-62943) (SAP Service Marketplace account required for access.)</span></span>

<span data-ttu-id="db865-297">在其他网络安全性方面，请考虑实施[外围网络](/azure/architecture/reference-architectures/dmz/secure-vnet-hybrid)。外围网络使用网络虚拟设备在 Web 调度程序子网和 Fiori 前端服务器池的前面创建防火墙。</span><span class="sxs-lookup"><span data-stu-id="db865-297">For additional network security, consider implementing a [Network DMZ](/azure/architecture/reference-architectures/dmz/secure-vnet-hybrid), which uses a network virtual appliance to create a firewall in front of the subnet for Web Dispatcher and Fiori Front-End Server pools.</span></span>

<span data-ttu-id="db865-298">在基础结构安全性方面，传输中数据和静态数据会加密。</span><span class="sxs-lookup"><span data-stu-id="db865-298">For infrastructure security, data is encrypted in transit and at rest.</span></span> <span data-ttu-id="db865-299">可参考 [Azure 虚拟机上的 SAP NetWeaver - 规划和实施指南](/azure/virtual-machines/workloads/sap/planning-guide)的“安全注意事项”部分解决网络安全问题，其内容也适用于 S/4HANA。</span><span class="sxs-lookup"><span data-stu-id="db865-299">The "Security considerations" section of the [SAP NetWeaver on Azure Virtual Machines–Planning and Implementation Guide](/azure/virtual-machines/workloads/sap/planning-guide) begins to address network security and applies to S/4HANA.</span></span> <span data-ttu-id="db865-300">该指南还指定了为使应用程序能够通信，而必须在防火墙中打开的网络端口。</span><span class="sxs-lookup"><span data-stu-id="db865-300">The guide also specifies the network ports you must open on the firewalls to allow application communication.</span></span> 

<span data-ttu-id="db865-301">若要加密 Linux IaaS 虚拟机磁盘，可以使用 [Azure 磁盘加密](/azure/security/azure-security-disk-encryption)。</span><span class="sxs-lookup"><span data-stu-id="db865-301">To encrypt Linux IaaS virtual machine disks, you can use [Azure Disk Encryption](/azure/security/azure-security-disk-encryption).</span></span> <span data-ttu-id="db865-302">磁盘加密使用 Linux 的 DM-Crypt 功能，为操作系统和数据磁盘提供卷加密。</span><span class="sxs-lookup"><span data-stu-id="db865-302">It uses the DM-Crypt feature of Linux to provide volume encryption for the operating system and the data disks.</span></span> <span data-ttu-id="db865-303">该解决方案还可与 Azure Key Vault 配合工作，帮助管理 Key Vault 订阅中的磁盘加密密钥和机密。</span><span class="sxs-lookup"><span data-stu-id="db865-303">The solution also works with Azure Key Vault to help you control and manage the disk-encryption keys and secrets in your key vault subscription.</span></span> <span data-ttu-id="db865-304">虚拟机磁盘上的数据将在 Azure 存储中静态加密。</span><span class="sxs-lookup"><span data-stu-id="db865-304">Data on the virtual machine disks are encrypted at rest in your Azure storage.</span></span>

<span data-ttu-id="db865-305">对于 SAP HANA 静态数据加密，我们建议使用 SAP HANA 本机加密技术。</span><span class="sxs-lookup"><span data-stu-id="db865-305">For SAP HANA data-at-rest encryption, we recommend using the SAP HANA native encryption technology.</span></span> 

> [!NOTE]
> <span data-ttu-id="db865-306">请不要在同一台服务器上同时使用 HANA 静态数据加密和 Azure 磁盘加密。</span><span class="sxs-lookup"><span data-stu-id="db865-306">Do not use the HANA data-at-rest encryption with Azure Disk Encryption on the same server.</span></span> <span data-ttu-id="db865-307">对于 HANA，请仅使用 HANA 数据加密。</span><span class="sxs-lookup"><span data-stu-id="db865-307">For HANA, use only HANA data encryption.</span></span>

## <a name="communities"></a><span data-ttu-id="db865-308">社区</span><span class="sxs-lookup"><span data-stu-id="db865-308">Communities</span></span>

<span data-ttu-id="db865-309">社区可以解答问题，并帮助设置成功的部署。</span><span class="sxs-lookup"><span data-stu-id="db865-309">Communities can answer questions and help you set up a successful deployment.</span></span> <span data-ttu-id="db865-310">请注意以下几点：</span><span class="sxs-lookup"><span data-stu-id="db865-310">Consider the following:</span></span>

- [<span data-ttu-id="db865-311">在 Microsoft 平台上运行 SAP 应用程序（博客）</span><span class="sxs-lookup"><span data-stu-id="db865-311">Running SAP Applications on the Microsoft Platform Blog</span></span>](https://blogs.msdn.microsoft.com/saponsqlserver/2017/05/04/sap-on-azure-general-update-for-customers-partners-april-2017/)
- [<span data-ttu-id="db865-312">Azure 社区支持</span><span class="sxs-lookup"><span data-stu-id="db865-312">Azure Community Support</span></span>](https://azure.microsoft.com/support/community/)
- [<span data-ttu-id="db865-313">SAP 社区</span><span class="sxs-lookup"><span data-stu-id="db865-313">SAP Community</span></span>](https://www.sap.com/community.html)
- [<span data-ttu-id="db865-314">Stack Overflow</span><span class="sxs-lookup"><span data-stu-id="db865-314">Stack Overflow</span></span>](https://stackoverflow.com/tags/sap/)

[visio-download]: https://archcenter.blob.core.windows.net/cdn/sap-reference-architectures.vsdx
