---
title: API 网关
description: 微服务中的 API 网关
author: MikeWasson
ms.date: 12/08/2017
ms.openlocfilehash: 6483d416363e24f4084d6b856847a740bf4054d9
ms.sourcegitcommit: a8453c4bc7c870fa1a12bb3c02e3b310db87530c
ms.translationtype: HT
ms.contentlocale: zh-CN
ms.lasthandoff: 12/29/2017
---
# <a name="designing-microservices-api-gateways"></a><span data-ttu-id="79666-103">设计微服务：API 网关</span><span class="sxs-lookup"><span data-stu-id="79666-103">Designing microservices: API gateways</span></span>

<span data-ttu-id="79666-104">在微服务体系结构中，客户端可能与多个前端服务进行交互。</span><span class="sxs-lookup"><span data-stu-id="79666-104">In a microservices architecture, a client might interact with more than one front-end service.</span></span> <span data-ttu-id="79666-105">如果存在这种情况，客户端如何知道要调用哪些终结点？</span><span class="sxs-lookup"><span data-stu-id="79666-105">Given this fact, how does a client know what endpoints to call?</span></span> <span data-ttu-id="79666-106">引入了新服务或者重构了现有服务时，会发生什么情况？</span><span class="sxs-lookup"><span data-stu-id="79666-106">What happens when new services are introduced, or existing services are refactored?</span></span> <span data-ttu-id="79666-107">服务如何处理 SSL 终止、身份验证和其他问题？</span><span class="sxs-lookup"><span data-stu-id="79666-107">How do services handle SSL termination, authentication, and other concerns?</span></span> <span data-ttu-id="79666-108">API 网关可以帮助解决这些难题。</span><span class="sxs-lookup"><span data-stu-id="79666-108">An *API gateway* can help to address these challenges.</span></span> 

![](./images/gateway.png)

## <a name="what-is-an-api-gateway"></a><span data-ttu-id="79666-109">什么是 API 网关?</span><span class="sxs-lookup"><span data-stu-id="79666-109">What is an API gateway?</span></span>

<span data-ttu-id="79666-110">API 网关位于客户端与服务之间。</span><span class="sxs-lookup"><span data-stu-id="79666-110">An API gateway sits between clients and services.</span></span> <span data-ttu-id="79666-111">它充当反向代理，将来自客户端的请求路由到服务。</span><span class="sxs-lookup"><span data-stu-id="79666-111">It acts as a reverse proxy, routing requests from clients to services.</span></span> <span data-ttu-id="79666-112">它还可以执行各种横切任务，例如身份验证、SSL 终止和速率限制。</span><span class="sxs-lookup"><span data-stu-id="79666-112">It may also perform various cross-cutting tasks such as authentication, SSL termination, and rate limiting.</span></span> <span data-ttu-id="79666-113">如果未部署网关，则客户端必须直接向前端服务发送请求。</span><span class="sxs-lookup"><span data-stu-id="79666-113">If you don't deploy a gateway, clients must send requests directly to front-end services.</span></span> <span data-ttu-id="79666-114">但是，直接向客户端公开服务会造成一些潜在问题：</span><span class="sxs-lookup"><span data-stu-id="79666-114">However, there are some potential problems with exposing services directly to clients:</span></span>

- <span data-ttu-id="79666-115">可能需要编写复杂的客户端代码。</span><span class="sxs-lookup"><span data-stu-id="79666-115">It can result in complex client code.</span></span> <span data-ttu-id="79666-116">客户端必须跟踪多个终结点，并以弹性方式处理故障。</span><span class="sxs-lookup"><span data-stu-id="79666-116">The client must keep track of multiple endpoints, and handle failures in a resilient way.</span></span> 
- <span data-ttu-id="79666-117">会在客户端与后端之间造成耦合。</span><span class="sxs-lookup"><span data-stu-id="79666-117">It creates coupling between the client and the backend.</span></span> <span data-ttu-id="79666-118">客户端需要知道如何分解各个服务。</span><span class="sxs-lookup"><span data-stu-id="79666-118">The client needs to know how the individual services are decomposed.</span></span> <span data-ttu-id="79666-119">因此，客户端维护和服务重构会变得更困难。</span><span class="sxs-lookup"><span data-stu-id="79666-119">That makes it harder to maintain the client and also harder to refactor services.</span></span>
- <span data-ttu-id="79666-120">单个操作可能需要调用多个服务。</span><span class="sxs-lookup"><span data-stu-id="79666-120">A single operation might require calls to multiple services.</span></span> <span data-ttu-id="79666-121">这可能导致在客户端与服务器之间经历多次网络往返，从而明显增大延迟。</span><span class="sxs-lookup"><span data-stu-id="79666-121">That can result in multiple network round trips between the client and the server, adding significant latency.</span></span> 
- <span data-ttu-id="79666-122">每个面向公众的服务必须处理身份验证、SSL 和客户端速率限制等问题。</span><span class="sxs-lookup"><span data-stu-id="79666-122">Each public-facing service must handle concerns such as authentication, SSL, and client rate limiting.</span></span> 
- <span data-ttu-id="79666-123">服务必须公开客户端友好的协议，例如 HTTP 或 WebSocket。</span><span class="sxs-lookup"><span data-stu-id="79666-123">Services must expose a client-friendly protocol such as HTTP or WebSocket.</span></span> <span data-ttu-id="79666-124">这就限制了[通信协议](./interservice-communication.md)的选择。</span><span class="sxs-lookup"><span data-stu-id="79666-124">This limits the choice of [communication protocols](./interservice-communication.md).</span></span> 
- <span data-ttu-id="79666-125">包含公共终结点的服务是潜在的受攻击面，必须得到强化。</span><span class="sxs-lookup"><span data-stu-id="79666-125">Services with public endpoints are a potential attack surface, and must be hardened.</span></span>

<span data-ttu-id="79666-126">网关可以通过将客户端与服务分开，来帮助解决这些问题。</span><span class="sxs-lookup"><span data-stu-id="79666-126">A gateway helps to address these issues by decoupling clients from services.</span></span> <span data-ttu-id="79666-127">网关可以执行许多不同的功能，但我们不一定需要所有这些功能。</span><span class="sxs-lookup"><span data-stu-id="79666-127">Gateways can perform a number of different functions, and you may not need all of them.</span></span> <span data-ttu-id="79666-128">这些功能可划分到以下设计模式：</span><span class="sxs-lookup"><span data-stu-id="79666-128">The functions can be grouped into the following design patterns:</span></span>

<span data-ttu-id="79666-129">[网关路由](../patterns/gateway-routing.md)。</span><span class="sxs-lookup"><span data-stu-id="79666-129">[Gateway Routing](../patterns/gateway-routing.md).</span></span> <span data-ttu-id="79666-130">使用网关作为反向代理，通过第 7 层路由将请求路由到一个或多个后端服务。</span><span class="sxs-lookup"><span data-stu-id="79666-130">Use the gateway as a reverse proxy to route requests to one or more backend services, using layer 7 routing.</span></span> <span data-ttu-id="79666-131">网关为客户端提供单一终结点，可帮助将客户端与服务分开。</span><span class="sxs-lookup"><span data-stu-id="79666-131">The gateway provides a single endpoint for clients, and helps to decouple clients from services.</span></span> 

<span data-ttu-id="79666-132">[网关聚合](../patterns/gateway-aggregation.md)。</span><span class="sxs-lookup"><span data-stu-id="79666-132">[Gateway Aggregation](../patterns/gateway-aggregation.md).</span></span> <span data-ttu-id="79666-133">使用网关可将多个单独请求聚合成一个请求。</span><span class="sxs-lookup"><span data-stu-id="79666-133">Use the gateway to aggregate multiple individual requests into a single request.</span></span> <span data-ttu-id="79666-134">当单个操作需要调用多个后端服务时，可以应用此模式。</span><span class="sxs-lookup"><span data-stu-id="79666-134">This pattern applies when a single operation requires calls to multiple backend services.</span></span> <span data-ttu-id="79666-135">客户端将一个请求发送到网关。</span><span class="sxs-lookup"><span data-stu-id="79666-135">The client sends one request to the gateway.</span></span> <span data-ttu-id="79666-136">网关会将请求分派到不同的后端系统，然后聚合结果并将其发回给客户端。</span><span class="sxs-lookup"><span data-stu-id="79666-136">The gateway dispatches requests to the various backend services, and then aggregates the results and sends them back to the client.</span></span> <span data-ttu-id="79666-137">这有助于减少客户端与后端之间的通信频率。</span><span class="sxs-lookup"><span data-stu-id="79666-137">This helps to reduce chattiness between the client and the backend.</span></span> 

<span data-ttu-id="79666-138">[网关卸载](../patterns/gateway-offloading.md)。</span><span class="sxs-lookup"><span data-stu-id="79666-138">[Gateway Offloading](../patterns/gateway-offloading.md).</span></span> <span data-ttu-id="79666-139">使用网关可将单个服务的功能卸载到网关，尤其适合用于解决横切问题。</span><span class="sxs-lookup"><span data-stu-id="79666-139">Use the gateway to offload functionality from individual services to the gateway, particularly cross-cutting concerns.</span></span> <span data-ttu-id="79666-140">可能有效的做法是将这些功能整合到一个位置，而不是让每个服务负责实现这些功能。</span><span class="sxs-lookup"><span data-stu-id="79666-140">It can be useful to consolidate these functions into one place, rather than making every service responsible for implementing them.</span></span> <span data-ttu-id="79666-141">对于需要专业技能才能正常实现的功能（例如身份验证和授权），这种做法尤其有效。</span><span class="sxs-lookup"><span data-stu-id="79666-141">This is particularly true for features that requires specialized skills to implement correctly, such as authentication and authorization.</span></span> 

<span data-ttu-id="79666-142">下面是可卸载到网关的一些功能示例：</span><span class="sxs-lookup"><span data-stu-id="79666-142">Here are some examples of functionality that could be offloaded to a gateway:</span></span>

- <span data-ttu-id="79666-143">SSL 终止</span><span class="sxs-lookup"><span data-stu-id="79666-143">SSL termination</span></span>
- <span data-ttu-id="79666-144">身份验证</span><span class="sxs-lookup"><span data-stu-id="79666-144">Authentication</span></span>
- <span data-ttu-id="79666-145">IP 白名单</span><span class="sxs-lookup"><span data-stu-id="79666-145">IP whitelisting</span></span>
- <span data-ttu-id="79666-146">客户端速率限制（限制）</span><span class="sxs-lookup"><span data-stu-id="79666-146">Client rate limiting (throttling)</span></span>
- <span data-ttu-id="79666-147">日志记录和监视</span><span class="sxs-lookup"><span data-stu-id="79666-147">Logging and monitoring</span></span>
- <span data-ttu-id="79666-148">响应缓存</span><span class="sxs-lookup"><span data-stu-id="79666-148">Response caching</span></span>
- <span data-ttu-id="79666-149">Web 应用程序防火墙</span><span class="sxs-lookup"><span data-stu-id="79666-149">Web application firewall</span></span>
- <span data-ttu-id="79666-150">GZIP 压缩</span><span class="sxs-lookup"><span data-stu-id="79666-150">GZIP compression</span></span>
- <span data-ttu-id="79666-151">为静态内容提供服务</span><span class="sxs-lookup"><span data-stu-id="79666-151">Servicing static content</span></span>

## <a name="choosing-a-gateway-technology"></a><span data-ttu-id="79666-152">选择网关技术</span><span class="sxs-lookup"><span data-stu-id="79666-152">Choosing a gateway technology</span></span>

<span data-ttu-id="79666-153">下面是在应用程序中实施 API 网关时可用的一些选项。</span><span class="sxs-lookup"><span data-stu-id="79666-153">Here are some options for implementing an API gateway in your application.</span></span>

- <span data-ttu-id="79666-154">**反向代理服务器**。</span><span class="sxs-lookup"><span data-stu-id="79666-154">**Reverse proxy server**.</span></span> <span data-ttu-id="79666-155">Nginx 和 HAProxy 是流行的反向代理服务器，它们支持负载均衡、SSL 和第 7 层路由等功能。</span><span class="sxs-lookup"><span data-stu-id="79666-155">Nginx and HAProxy are popular reverse proxy servers that support features such as load balancing, SSL, and layer 7 routing.</span></span> <span data-ttu-id="79666-156">两者都是免费的开源产品，付费版本提供更多的功能和支持选项。</span><span class="sxs-lookup"><span data-stu-id="79666-156">They are both free, open-source products, with paid editions that provide additional features and support options.</span></span> <span data-ttu-id="79666-157">Nginx 和 HAProxy 是具有丰富功能集和高性能的成熟产品。</span><span class="sxs-lookup"><span data-stu-id="79666-157">Nginx and HAProxy are both mature products with rich feature sets and high performance.</span></span> <span data-ttu-id="79666-158">可以使用第三方模块或者以 Lua 编写自定义脚本来扩展这两个产品。</span><span class="sxs-lookup"><span data-stu-id="79666-158">You can extend them with third-party modules or by writing custom scripts in Lua.</span></span> <span data-ttu-id="79666-159">Nginx 还支持名为 NginScript 的基于 JavaScript 的脚本模块。</span><span class="sxs-lookup"><span data-stu-id="79666-159">Nginx also supports a JavaScript-based scripting module called NginScript.</span></span>

- <span data-ttu-id="79666-160">**服务网格入口控制器**。</span><span class="sxs-lookup"><span data-stu-id="79666-160">**Service mesh ingress controller**.</span></span> <span data-ttu-id="79666-161">如果使用 linkerd 或 Istio 等服务网格，请考虑该服务网格的入口控制器所提供的功能。</span><span class="sxs-lookup"><span data-stu-id="79666-161">If you are using a service mesh such as linkerd or Istio, consider the features that are provided by the ingress controller for that service mesh.</span></span> <span data-ttu-id="79666-162">例如，Istio 入口控制器支持第 7 层路由、HTTP 重定向、重试和其他功能。</span><span class="sxs-lookup"><span data-stu-id="79666-162">For example, the Istio ingress controller supports layer 7 routing, HTTP redirects, retries, and other features.</span></span> 

- <span data-ttu-id="79666-163">[Azure 应用程序网关](/azure/application-gateway/)。</span><span class="sxs-lookup"><span data-stu-id="79666-163">[Azure Application Gateway](/azure/application-gateway/).</span></span> <span data-ttu-id="79666-164">应用程序网关是托管的负载均衡服务，可以执行第 7 层路由和 SSL 终止。</span><span class="sxs-lookup"><span data-stu-id="79666-164">Application Gateway is a managed load balancing service that can perform layer-7 routing and SSL termination.</span></span> <span data-ttu-id="79666-165">它还提供 Web 应用程序防火墙 (WAF)。</span><span class="sxs-lookup"><span data-stu-id="79666-165">It also provides a web application firewall (WAF).</span></span>

- <span data-ttu-id="79666-166">[Azure API 管理](/azure/api-management/)。</span><span class="sxs-lookup"><span data-stu-id="79666-166">[Azure API Management](/azure/api-management/).</span></span> <span data-ttu-id="79666-167">API 管理是可将 API 发布到外部和内部客户的统包式解决方案。</span><span class="sxs-lookup"><span data-stu-id="79666-167">API Management is a turnkey solution for publishing APIs to external and internal customers.</span></span> <span data-ttu-id="79666-168">它提供可用于管理面向公众的 API 的功能，包括速率限制、IP 允许列表，以及使用 Azure Active Directory 或其他标识提供者进行身份验证。</span><span class="sxs-lookup"><span data-stu-id="79666-168">It provides features that are useful for managing a public-facing API, including rate limiting, IP white listing, and authentication using Azure Active Directory or other identity providers.</span></span> <span data-ttu-id="79666-169">API 管理不执行任何负载均衡，因此，应该将它与应用程序网关或反向代理等负载均衡器结合使用。</span><span class="sxs-lookup"><span data-stu-id="79666-169">API Management doesn't perform any load balancing, so it should be used in conjunction with a load balancer such as Application Gateway or a reverse proxy.</span></span>

<span data-ttu-id="79666-170">选择网关技术时，请考虑以下因素：</span><span class="sxs-lookup"><span data-stu-id="79666-170">When choosing a gateway technology, consider the following:</span></span>

<span data-ttu-id="79666-171">**功能**。</span><span class="sxs-lookup"><span data-stu-id="79666-171">**Features**.</span></span> <span data-ttu-id="79666-172">上面列出的选项都支持第 7 层路由，但对其他功能的支持有所不同。</span><span class="sxs-lookup"><span data-stu-id="79666-172">The options listed above all support layer 7 routing, but support for other features will vary.</span></span> <span data-ttu-id="79666-173">可以根据所需的功能部署多个网关。</span><span class="sxs-lookup"><span data-stu-id="79666-173">Depending on the features that you need, you might deploy more than one gateway.</span></span> 

<span data-ttu-id="79666-174">**部署**。</span><span class="sxs-lookup"><span data-stu-id="79666-174">**Deployment**.</span></span> <span data-ttu-id="79666-175">Azure 应用程序网关和 API 管理属于托管服务。</span><span class="sxs-lookup"><span data-stu-id="79666-175">Azure Application Gateway and API Management are managed services.</span></span> <span data-ttu-id="79666-176">Nginx 和 HAProxy 通常在群集内的容器中运行，但也可以将其部署到群集外部的专用 VM 上。</span><span class="sxs-lookup"><span data-stu-id="79666-176">Nginx and HAProxy will typically run in containers inside the cluster, but can also be deployed to dedicated VMs outside of the cluster.</span></span> <span data-ttu-id="79666-177">这样就可以将网关与其他工作负荷隔离开来，但可能会产生较高的管理开销。</span><span class="sxs-lookup"><span data-stu-id="79666-177">This isolates the gateway from the rest of the workload, but incurs higher management overhead.</span></span>

<span data-ttu-id="79666-178">**管理**。</span><span class="sxs-lookup"><span data-stu-id="79666-178">**Management**.</span></span> <span data-ttu-id="79666-179">更新服务或者添加新服务后，可能需要更新网关路由规则。</span><span class="sxs-lookup"><span data-stu-id="79666-179">When services are updated or new services are added, the gateway routing rules may need to be updated.</span></span> <span data-ttu-id="79666-180">请考虑如何管理此过程。</span><span class="sxs-lookup"><span data-stu-id="79666-180">Consider how this process will be managed.</span></span> <span data-ttu-id="79666-181">类似的注意事项同样适用于管理 SSL 证书、IP 允许列表和其他配置方面。</span><span class="sxs-lookup"><span data-stu-id="79666-181">Similar considerations apply to managing SSL certificates, IP whitelists, and other aspects of configuration.</span></span>

## <a name="deployment-considerations"></a><span data-ttu-id="79666-182">部署注意事项</span><span class="sxs-lookup"><span data-stu-id="79666-182">Deployment considerations</span></span>

### <a name="deploying-nginx-or-haproxy-to-kubernetes"></a><span data-ttu-id="79666-183">将 Nginx 或 HAProxy 部署到 Kubernetes</span><span class="sxs-lookup"><span data-stu-id="79666-183">Deploying Nginx or HAProxy to Kubernetes</span></span>

<span data-ttu-id="79666-184">可将 Nginx 或 HAProxy 作为 [ReplicaSet](https://kubernetes.io/docs/concepts/workloads/controllers/replicaset/) 或 [DaemonSet](https://kubernetes.io/docs/concepts/workloads/controllers/daemonset/)（指定 Nginx 或 HAProxy 容器映像）部署到 Kubernetes。</span><span class="sxs-lookup"><span data-stu-id="79666-184">You can deploy Nginx or HAProxy to Kubernetes as a [ReplicaSet](https://kubernetes.io/docs/concepts/workloads/controllers/replicaset/) or [DaemonSet](https://kubernetes.io/docs/concepts/workloads/controllers/daemonset/) that specifies the Nginx or HAProxy container image.</span></span> <span data-ttu-id="79666-185">使用 ConfigMap 存储代理的配置文件，然后将 ConfigMap 装载为卷。</span><span class="sxs-lookup"><span data-stu-id="79666-185">Use a ConfigMap to store the configuration file for the proxy, and mount the ConfigMap as a volume.</span></span> <span data-ttu-id="79666-186">创建 LoadBalancer 类型的服务，以通过 Azure 负载均衡器公开网关。</span><span class="sxs-lookup"><span data-stu-id="79666-186">Create a service of type LoadBalancer to expose the gateway through an Azure Load Balancer.</span></span> 

<!-- - Configure a readiness probe that serves a static file from the gateway (rather than routing to another service). -->

<span data-ttu-id="79666-187">一种替代方法是创建入口控制器。</span><span class="sxs-lookup"><span data-stu-id="79666-187">An alternative is to create an Ingress Controller.</span></span> <span data-ttu-id="79666-188">入口控制器是部署负载均衡器或反向代理服务器的 Kubernetes 资源。</span><span class="sxs-lookup"><span data-stu-id="79666-188">An Ingress Controller is a Kubernetes resource that deploys a load balancer or reverse proxy server.</span></span> <span data-ttu-id="79666-189">有多种实施方案，包括 Nginx 和 HAProxy。</span><span class="sxs-lookup"><span data-stu-id="79666-189">Several implementations exist, including Nginx and HAProxy.</span></span> <span data-ttu-id="79666-190">有一个名为 Ingress 的独立资源可以定义入口控制器的设置，例如路由规则和 TLS 证书。</span><span class="sxs-lookup"><span data-stu-id="79666-190">A separate resource called an Ingress defines settings for the Ingress Controller, such as routing rules and TLS certificates.</span></span> <span data-ttu-id="79666-191">这样，我们就无需管理特定代理服务器技术的复杂配置文件。</span><span class="sxs-lookup"><span data-stu-id="79666-191">That way, you don't need to manage complex configuration files that are specific to a particular proxy server technology.</span></span> <span data-ttu-id="79666-192">在撰写本文时，入口控制器仍是 Kubernetes 的 Beta 版功能，该功能将不断改进。</span><span class="sxs-lookup"><span data-stu-id="79666-192">Ingress Controllers are still a beta feature of Kubernetes at the time of this writing, and the feature will continue to evolve.</span></span>

<span data-ttu-id="79666-193">网关是系统中的潜在瓶颈或单一故障点，因此，应至少部署两个副本以实现高可用性。</span><span class="sxs-lookup"><span data-stu-id="79666-193">The gateway is a potential bottleneck or single point of failure in the system, so always deploy at least two replicas for high availability.</span></span> <span data-ttu-id="79666-194">根据具体的负载，可能需要进一步横向扩展副本。</span><span class="sxs-lookup"><span data-stu-id="79666-194">You may need to scale out the replicas further, depending on the load.</span></span> 

<span data-ttu-id="79666-195">另外，请考虑在群集中的一组专用节点上运行网关。</span><span class="sxs-lookup"><span data-stu-id="79666-195">Also consider running the gateway on a dedicated set of nodes in the cluster.</span></span> <span data-ttu-id="79666-196">这种做法的好处包括：</span><span class="sxs-lookup"><span data-stu-id="79666-196">Benefits to this approach include:</span></span>

- <span data-ttu-id="79666-197">隔离。</span><span class="sxs-lookup"><span data-stu-id="79666-197">Isolation.</span></span> <span data-ttu-id="79666-198">所有入站流量将转到可与后端服务相隔离的固定一组节点。</span><span class="sxs-lookup"><span data-stu-id="79666-198">All inbound traffic goes to a fixed set of nodes, which can be isolated from backend services.</span></span>

- <span data-ttu-id="79666-199">稳定的配置。</span><span class="sxs-lookup"><span data-stu-id="79666-199">Stable configuration.</span></span> <span data-ttu-id="79666-200">如果网关配置不当，则整个应用程序可能不可用。</span><span class="sxs-lookup"><span data-stu-id="79666-200">If the gateway is misconfigured, the entire application may become unavailable.</span></span> 

- <span data-ttu-id="79666-201">性能。</span><span class="sxs-lookup"><span data-stu-id="79666-201">Performance.</span></span> <span data-ttu-id="79666-202">出于性能原因，可能需要对网关使用特定的 VM 配置。</span><span class="sxs-lookup"><span data-stu-id="79666-202">You may want to use a specific VM configuration for the gateway for performance reasons.</span></span>

<!-- - Load balancing. You can configure the external load balancer so that requests always go to a gateway node. That can save a network hop, which would otherwise happen whenever a request lands on a node that isn't running a gateway pod. This consideration applies mainly to large clusters, where the gateway runs on a relatively small fraction of the total nodes. In Azure Container Service (ACS), this approach currently requires [ACS Engine](https://github.com/Azure/acs-engine)) which allows you to create multiple agent pools. Then you can deploy the gateway as a DaemonSet to the front-end pool. -->

### <a name="azure-application-gateway"></a><span data-ttu-id="79666-203">Azure 应用程序网关</span><span class="sxs-lookup"><span data-stu-id="79666-203">Azure Application Gateway</span></span>

<span data-ttu-id="79666-204">将应用程序网关连接到 Azure 中的 Kubernetes 群集：</span><span class="sxs-lookup"><span data-stu-id="79666-204">To connect Application Gateway to a Kubernetes cluster in Azure:</span></span>

1. <span data-ttu-id="79666-205">在群集 VNet 中创建一个空子网。</span><span class="sxs-lookup"><span data-stu-id="79666-205">Create an empty subnet in the cluster VNet.</span></span>
2. <span data-ttu-id="79666-206">部署应用程序网关。</span><span class="sxs-lookup"><span data-stu-id="79666-206">Deploy Application Gateway.</span></span>
3. <span data-ttu-id="79666-207">创建类型为 [NodePort](https://kubernetes.io/docs/concepts/services-networking/service/#type-nodeport) 的 Kubernetes 服务。</span><span class="sxs-lookup"><span data-stu-id="79666-207">Create a Kubernetes service with type=[NodePort](https://kubernetes.io/docs/concepts/services-networking/service/#type-nodeport).</span></span> <span data-ttu-id="79666-208">这会在每个节点上公开该服务，以便可以从群集外部访问它。</span><span class="sxs-lookup"><span data-stu-id="79666-208">This exposes the service on each node so that it can be reached from outside the cluster.</span></span> <span data-ttu-id="79666-209">此操作不会创建负载均衡器。</span><span class="sxs-lookup"><span data-stu-id="79666-209">It does not create a load balancer.</span></span>
5. <span data-ttu-id="79666-210">获取该服务的分配端口号。</span><span class="sxs-lookup"><span data-stu-id="79666-210">Get the assigned port number for the service.</span></span>
6. <span data-ttu-id="79666-211">添加应用程序网关规则，其中：</span><span class="sxs-lookup"><span data-stu-id="79666-211">Add an Application Gateway rule where:</span></span>
    - <span data-ttu-id="79666-212">后端池包含代理 VM。</span><span class="sxs-lookup"><span data-stu-id="79666-212">The backend pool contains the agent VMs.</span></span>
    - <span data-ttu-id="79666-213">HTTP 设置指定服务端口号。</span><span class="sxs-lookup"><span data-stu-id="79666-213">The HTTP setting specifies the service port number.</span></span>
    - <span data-ttu-id="79666-214">网关侦听器侦听端口 80/443</span><span class="sxs-lookup"><span data-stu-id="79666-214">The gateway listener listens on ports 80/443</span></span>
    
<span data-ttu-id="79666-215">将实例计数设置为 2 或更大，以实现高可用性。</span><span class="sxs-lookup"><span data-stu-id="79666-215">Set the instance count to 2 or more for high availability.</span></span>

### <a name="azure-api-management"></a><span data-ttu-id="79666-216">Azure API 管理</span><span class="sxs-lookup"><span data-stu-id="79666-216">Azure API Management</span></span> 

<span data-ttu-id="79666-217">将 API 管理连接到 Azure 中的 Kubernetes 群集：</span><span class="sxs-lookup"><span data-stu-id="79666-217">To connect API Management to a Kubernetes cluster in Azure:</span></span>

1. <span data-ttu-id="79666-218">在群集 VNet 中创建一个空子网。</span><span class="sxs-lookup"><span data-stu-id="79666-218">Create an empty subnet in the cluster VNet.</span></span>
2. <span data-ttu-id="79666-219">将 API 管理部署到该子网。</span><span class="sxs-lookup"><span data-stu-id="79666-219">Deploy API Management to that subnet.</span></span>
3. <span data-ttu-id="79666-220">创建 LoadBalancer 类型的 Kubernetes 服务。</span><span class="sxs-lookup"><span data-stu-id="79666-220">Create a Kubernetes service of type LoadBalancer.</span></span> <span data-ttu-id="79666-221">使用[内部负载均衡器](https://kubernetes.io/docs/concepts/services-networking/service/#internal-load-balancer)注释创建内部负载均衡，而不要使用默认的面向 Internet 的负载均衡器。</span><span class="sxs-lookup"><span data-stu-id="79666-221">Use the [internal load balancer](https://kubernetes.io/docs/concepts/services-networking/service/#internal-load-balancer) annotation to create an internal load balancer, instead of an Internet-facing load balancer, which is the default.</span></span>
4. <span data-ttu-id="79666-222">使用 kubectl 或 Azure CLI 查找内部负载均衡器的专用 IP。</span><span class="sxs-lookup"><span data-stu-id="79666-222">Find the private IP of the internal load balancer, using kubectl or the Azure CLI.</span></span>
5. <span data-ttu-id="79666-223">使用 API 管理创建定向到负载均衡器专用 IP 地址的 API。</span><span class="sxs-lookup"><span data-stu-id="79666-223">Use API Management to create an API that directs to the private IP address of the load balancer.</span></span>

<span data-ttu-id="79666-224">考虑将 API 管理与某个反向代理（不管是 Nginx、HAProxy 还是 Azure 应用程序网关）结合使用。</span><span class="sxs-lookup"><span data-stu-id="79666-224">Consider combining API Management with a reverse proxy, whether Nginx, HAProxy, or Azure Application Gateway.</span></span> <span data-ttu-id="79666-225">有关将 API 管理与应用程序网关配合使用的信息，请参阅[在包含应用程序网关的内部 VNET 中集成 API 管理](/azure/api-management/api-management-howto-integrate-internal-vnet-appgateway)。</span><span class="sxs-lookup"><span data-stu-id="79666-225">For information about using API Management with Application Gateway, see [Integrate API Management in an internal VNET with Application Gateway](/azure/api-management/api-management-howto-integrate-internal-vnet-appgateway).</span></span>

> [!div class="nextstepaction"]
> [<span data-ttu-id="79666-226">日志记录和监视</span><span class="sxs-lookup"><span data-stu-id="79666-226">Logging and monitoring</span></span>](./logging-monitoring.md)
