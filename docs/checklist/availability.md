---
title: "可用性核对清单"
description: "为设计过程中的可用性考虑因素提供指导的核对清单。"
author: dragon119
ms.date: 03/24/2017
ms.custom: checklist
ms.openlocfilehash: 14e6cd6f25f613ea9793b5cf6c4f1abe6f405b74
ms.sourcegitcommit: b0482d49aab0526be386837702e7724c61232c60
ms.translationtype: HT
ms.contentlocale: zh-CN
ms.lasthandoff: 11/14/2017
---
# <a name="availability-checklist"></a><span data-ttu-id="43ead-103">可用性核对清单</span><span class="sxs-lookup"><span data-stu-id="43ead-103">Availability checklist</span></span>
[!INCLUDE [header](../_includes/header.md)]

## <a name="application-design"></a><span data-ttu-id="43ead-104">应用程序设计</span><span class="sxs-lookup"><span data-stu-id="43ead-104">Application design</span></span>
* <span data-ttu-id="43ead-105">**避免任何单点故障。**</span><span class="sxs-lookup"><span data-stu-id="43ead-105">**Avoid any single point of failure.**</span></span> <span data-ttu-id="43ead-106">为避免单点故障影响可用性，应该将所有组件、服务、资源和计算实例部署为多个实例。</span><span class="sxs-lookup"><span data-stu-id="43ead-106">All components, services, resources, and compute instances should be deployed as multiple instances to prevent a single point of failure from affecting availability.</span></span> <span data-ttu-id="43ead-107">这包括身份验证机制。</span><span class="sxs-lookup"><span data-stu-id="43ead-107">This includes authentication mechanisms.</span></span> <span data-ttu-id="43ead-108">将应用程序设计为可配置为使用多个实例，自动检测失败，并将请求重定向到未失败的实例（平台并不在其中自动执行此操作）。</span><span class="sxs-lookup"><span data-stu-id="43ead-108">Design the application to be configurable to use multiple instances, and to automatically detect failures and redirect requests to non-failed instances where the platform does not do this automatically.</span></span>
* <span data-ttu-id="43ead-109">**根据不同的服务级别协议分解工作负荷。**</span><span class="sxs-lookup"><span data-stu-id="43ead-109">**Decompose workload per different service-level agreement.**</span></span> <span data-ttu-id="43ead-110">如果服务由重要和比较不重要的工作负荷组成，请以不同的方式进行管理，并指定服务功能和实例数，以符合其可用性要求。</span><span class="sxs-lookup"><span data-stu-id="43ead-110">If a service is composed of critical and less-critical workloads, manage them differently and specify the service features and number of instances to meet their availability requirements.</span></span>
* <span data-ttu-id="43ead-111">**最小化和了解服务依赖项。**</span><span class="sxs-lookup"><span data-stu-id="43ead-111">**Minimize and understand service dependencies.**</span></span> <span data-ttu-id="43ead-112">尽可能将使用过的不同服务数降到最低，并确保了解所有存在于系统中的功能和服务依赖项，</span><span class="sxs-lookup"><span data-stu-id="43ead-112">Minimize the number of different services used where possible, and ensure you understand all of the feature and service dependencies that exist in the system.</span></span> <span data-ttu-id="43ead-113">包括这些依赖项的性质、失败造成的影响，或整个应用程序上每个服务降低的性能。</span><span class="sxs-lookup"><span data-stu-id="43ead-113">This includes the nature of these dependencies, and the impact of failure or reduced performance in each one on the overall application.</span></span> <span data-ttu-id="43ead-114">Microsoft 保证大多数服务至少提供 99.9% 的可用性，但这意味着应用程序依赖的其他每个服务可能降低 0.1% 的系统整体可用性 SLA。</span><span class="sxs-lookup"><span data-stu-id="43ead-114">Microsoft guarantees at least 99.9 percent availability for most services, but this means that every additional service an application relies on potentially reduces the overall availability SLA of your system by 0.1 percent.</span></span>
* <span data-ttu-id="43ead-115">**尽可能将任务和消息设计为幂等（安全重复）**，使重复的请求不会导致问题。</span><span class="sxs-lookup"><span data-stu-id="43ead-115">**Design tasks and messages to be idempotent (safely repeatable) where possible**, so that duplicated requests will not cause problems.</span></span> <span data-ttu-id="43ead-116">例如，服务可以充当处理消息的使用者，这些消息由系统中充当生成者的其他部分发送为请求。</span><span class="sxs-lookup"><span data-stu-id="43ead-116">For example, a service can act as a consumer that handles messages sent as requests by other parts of the system that act as producers.</span></span> <span data-ttu-id="43ead-117">如果使用者在处理消息之后、确认消息已处理之前失败，生成者可以提交重复请求，由使用者的另一个实例处理。</span><span class="sxs-lookup"><span data-stu-id="43ead-117">If the consumer fails after processing the message, but before acknowledging that it has been processed, a producer might submit a repeat request which could be handled by another instance of the consumer.</span></span> <span data-ttu-id="43ead-118">出于此原因，使用者与它们执行的操作应该具有幂等性，以便重复以前执行的操作不会使结果无效。</span><span class="sxs-lookup"><span data-stu-id="43ead-118">For this reason, consumers and the operations they carry out should be idempotent so that repeating a previously executed operation does not render the results invalid.</span></span> <span data-ttu-id="43ead-119">这可能意味着要检测重复消息或使用乐观方法来处理冲突以确保一致性。</span><span class="sxs-lookup"><span data-stu-id="43ead-119">This may mean detecting duplicated messages, or ensuring consistency by using an optimistic approach to handling conflicts.</span></span>
* <span data-ttu-id="43ead-120">**使用消息代理来为重要事务实现高可用性。**</span><span class="sxs-lookup"><span data-stu-id="43ead-120">**Use a message broker that implements high availability for critical transactions.**</span></span> <span data-ttu-id="43ead-121">用于启动任务或访问远程服务的许多方案都使用消息传送在应用程序与目标服务之间传递指令。</span><span class="sxs-lookup"><span data-stu-id="43ead-121">Many scenarios for initiating tasks or accessing remote services use messaging to pass instructions between the application and the target service.</span></span> <span data-ttu-id="43ead-122">为了获得最佳性能，应用程序应该能够发送消息，并返回以处理更多请求，而无需等待回复。</span><span class="sxs-lookup"><span data-stu-id="43ead-122">For best performance, the application should be able to send the message and then return to process more requests, without needing to wait for a reply.</span></span> <span data-ttu-id="43ead-123">若要保证传送消息，消息传送系统应提供高可用性。</span><span class="sxs-lookup"><span data-stu-id="43ead-123">To guarantee delivery of messages, the messaging system should provide high availability.</span></span> <span data-ttu-id="43ead-124">Azure 服务总线消息队列实施*至少一次*语义。</span><span class="sxs-lookup"><span data-stu-id="43ead-124">Azure Service Bus message queues implement *at least once* semantics.</span></span> <span data-ttu-id="43ead-125">这意味着，发布到队列的每个消息都不会丢失，不过在某些情况下可能会发送重复的副本。</span><span class="sxs-lookup"><span data-stu-id="43ead-125">This means that each message posted to a queue will not be lost, although duplicate copies may be delivered under certain circumstances.</span></span> <span data-ttu-id="43ead-126">如果消息处理是幂等的（请参阅前一项），则重复传送应该不是问题。</span><span class="sxs-lookup"><span data-stu-id="43ead-126">If message processing is idempotent (see the previous item), repeated delivery should not be a problem.</span></span>
* <span data-ttu-id="43ead-127">**将应用程序设计为在达到资源限制时适当降级**，并采取适当的措施将对用户的影响降到最低。</span><span class="sxs-lookup"><span data-stu-id="43ead-127">**Design applications to gracefully degrade** when reaching resource limits, and take appropriate action to minimize the impact for the user.</span></span> <span data-ttu-id="43ead-128">在某些情况下，应用程序上的负载可能超出一个或多个部件的容量，导致降低可用性和连接失败。</span><span class="sxs-lookup"><span data-stu-id="43ead-128">In some cases, the load on the application may exceed the capacity of one or more parts, causing reduced availability and failed connections.</span></span> <span data-ttu-id="43ead-129">缩放有助于缓解此问题，但可能会达到资源可用性或成本等其他因素施加的限制。</span><span class="sxs-lookup"><span data-stu-id="43ead-129">Scaling can help to alleviate this, but it may reach a limit imposed by other factors, such as resource availability or cost.</span></span> <span data-ttu-id="43ead-130">将应用程序设计为可在此情况下自动适当地降级。</span><span class="sxs-lookup"><span data-stu-id="43ead-130">Design the application so that, in this situation, it can automatically degrade gracefully.</span></span> <span data-ttu-id="43ead-131">例如，在电子商务系统中，如果订单处理子系统处于高压状态（甚至完全故障），可以暂时禁用该子系统，同时允许其他功能（例如浏览产品目录）继续工作。</span><span class="sxs-lookup"><span data-stu-id="43ead-131">For example, in an ecommerce system, if the order-processing subsystem is under strain (or has even failed completely), it can be temporarily disabled while allowing other functionality (such as browsing the product catalog) to continue.</span></span> <span data-ttu-id="43ead-132">适当的做法是延后对故障子系统发出的请求，例如，仍然允许客户提交订单，但同时要保存订单，以便在订单子系统稍后再次可用时进行处理。</span><span class="sxs-lookup"><span data-stu-id="43ead-132">It might be appropriate to postpone requests to a failing subsystem, for example still enabling customers to submit orders but saving them for later processing, when the orders subsystem is available again.</span></span>
* <span data-ttu-id="43ead-133">**适当处理急剧突发事件。**</span><span class="sxs-lookup"><span data-stu-id="43ead-133">**Gracefully handle rapid burst events.**</span></span> <span data-ttu-id="43ead-134">大多数应用程序需要处理不同时间的不同工作负荷，例如业务应用程序中上午出现的第一波高峰，或者电子商务网站中发布新产品时。</span><span class="sxs-lookup"><span data-stu-id="43ead-134">Most applications need to handle varying workloads over time, such as peaks first thing in the morning in a business application or when a new product is released in an ecommerce site.</span></span> <span data-ttu-id="43ead-135">自动缩放有助于处理负载，但可能需要一些时间使其他实例联机并处理请求。</span><span class="sxs-lookup"><span data-stu-id="43ead-135">Auto-scaling can help to handle the load, but it may take some time for additional instances to come online and handle requests.</span></span> <span data-ttu-id="43ead-136">通过将应用程序设计为将请求加入其使用的服务队列，并在队列接近完全容量时适当降级，以防止突发和意外的活动高峰导致超出应用程序的处理能力。</span><span class="sxs-lookup"><span data-stu-id="43ead-136">Prevent sudden and unexpected bursts of activity from overwhelming the application: design it to queue requests to the services it uses and degrade gracefully when queues are near to full capacity.</span></span> <span data-ttu-id="43ead-137">确保有足够的性能和容量可供非高峰条件清空队列和处理未完成的请求。</span><span class="sxs-lookup"><span data-stu-id="43ead-137">Ensure that there is sufficient performance and capacity available under non-burst conditions to drain the queues and handle outstanding requests.</span></span> <span data-ttu-id="43ead-138">有关详细信息，请参阅 [Queue-Based Load Leveling Pattern](https://msdn.microsoft.com/library/dn589783.aspx)（基于队列的负载调节模式）。</span><span class="sxs-lookup"><span data-stu-id="43ead-138">For more information, see the [Queue-Based Load Leveling Pattern](https://msdn.microsoft.com/library/dn589783.aspx).</span></span>

## <a name="deployment-and-maintenance"></a><span data-ttu-id="43ead-139">部署和维护</span><span class="sxs-lookup"><span data-stu-id="43ead-139">Deployment and maintenance</span></span>
* <span data-ttu-id="43ead-140">**为每个服务部署角色的多个实例。**</span><span class="sxs-lookup"><span data-stu-id="43ead-140">**Deploy multiple instances of roles for each service.**</span></span> <span data-ttu-id="43ead-141">Microsoft 提供创建和部署的服务提供可用性保证，但这些保证的有效前提是必须在服务中为每个角色部署至少两个实例。</span><span class="sxs-lookup"><span data-stu-id="43ead-141">Microsoft makes availability guarantees for services that you create and deploy, but these guarantees are only valid if you deploy at least two instances of each role in the service.</span></span> <span data-ttu-id="43ead-142">这样，其中一个角色可以不可用，而另一个实例保持活动状态。</span><span class="sxs-lookup"><span data-stu-id="43ead-142">This enables one role to be unavailable while the other remains active.</span></span> <span data-ttu-id="43ead-143">如果想要将更新部署到实时系统而不中断客户端的活动，这项保证就特别重要；实例可以单独中断和升级，而其他实例将继续保持联机。</span><span class="sxs-lookup"><span data-stu-id="43ead-143">This is especially important if you need to deploy updates to a live system without interrupting clients' activities; instances can be taken down and upgraded individually while the others continue online.</span></span>
* <span data-ttu-id="43ead-144">**在多个数据中心托管应用程序。**</span><span class="sxs-lookup"><span data-stu-id="43ead-144">**Host applications in multiple datacenters.**</span></span> <span data-ttu-id="43ead-145">整个数据中心可能因为自然灾害或 Internet 故障等事件而脱机，不过这种情况极其少见。</span><span class="sxs-lookup"><span data-stu-id="43ead-145">Although extremely unlikely, it is possible for an entire datacenter to go offline through an event such as a natural disaster or Internet failure.</span></span> <span data-ttu-id="43ead-146">至关重要的业务应用程序应该托管在多个数据中心，以提供最大的可用性。</span><span class="sxs-lookup"><span data-stu-id="43ead-146">Vital business applications should be hosted in more than one datacenter to provide maximum availability.</span></span> <span data-ttu-id="43ead-147">这样做还可以减少本地用户的延迟，并在更新应用程序时进一步提供弹性。</span><span class="sxs-lookup"><span data-stu-id="43ead-147">This can also reduce latency for local users, and provide additional opportunities for flexibility when updating applications.</span></span>
* <span data-ttu-id="43ead-148">**自动化和测试部署与维护任务。**</span><span class="sxs-lookup"><span data-stu-id="43ead-148">**Automate and test deployment and maintenance tasks.**</span></span> <span data-ttu-id="43ead-149">分布式应用程序由多个必须共同工作的部件组成。</span><span class="sxs-lookup"><span data-stu-id="43ead-149">Distributed applications consist of multiple parts that must work together.</span></span> <span data-ttu-id="43ead-150">因此，部署应该使用经过测试和证实的机制（例如脚本和部署应用程序）来自动化。</span><span class="sxs-lookup"><span data-stu-id="43ead-150">Deployment should therefore be automated, using tested and proven mechanisms such as scripts and deployment applications.</span></span> <span data-ttu-id="43ead-151">这些脚本和应用程序可更新并验证配置，以及自动化部署过程。</span><span class="sxs-lookup"><span data-stu-id="43ead-151">These can update and validate configuration, and automate the deployment process.</span></span> <span data-ttu-id="43ead-152">自动化技术还应该用于执行全部或部分应用程序的更新。</span><span class="sxs-lookup"><span data-stu-id="43ead-152">Automated techniques should also be used to perform updates of all or parts of applications.</span></span> <span data-ttu-id="43ead-153">务必全面测试所有过程，以确保错误不会导致其他停机情况。</span><span class="sxs-lookup"><span data-stu-id="43ead-153">It is vital to test all of these processes fully to ensure that errors do not cause additional downtime.</span></span> <span data-ttu-id="43ead-154">所有的部署工具必须有适当的安全限制，以保护部署的应用程序；慎重定义和强制实施部署策略，并将人为介入的需要降到最低。</span><span class="sxs-lookup"><span data-stu-id="43ead-154">All deployment tools must have suitable security restrictions to protect the deployed application; define and enforce deployment policies carefully and minimize the need for human intervention.</span></span>
* <span data-ttu-id="43ead-155">**考虑使用平台的过渡和生产功能**，其中包括上述所有功能。</span><span class="sxs-lookup"><span data-stu-id="43ead-155">**Consider using staging and production features of the platform** where these are available.</span></span> <span data-ttu-id="43ead-156">例如，使用 Azure 云服务过渡与生产环境可使应用程序通过虚拟 IP 地址交换（VIP 交换）的方式即时相互切换。</span><span class="sxs-lookup"><span data-stu-id="43ead-156">For example, using Azure Cloud Services staging and production environments allows applications to be switched from one to another instantly through a virtual IP address swap (VIP Swap).</span></span> <span data-ttu-id="43ead-157">但是，如果倾向在本地过渡或同时部署不同版本的应用程序并逐渐迁移用户，也许不能使用 VIP 交换操作。</span><span class="sxs-lookup"><span data-stu-id="43ead-157">However, if you prefer to stage on-premises, or deploy different versions of the application concurrently and gradually migrate users, you may not be able to use a VIP Swap operation.</span></span>
* <span data-ttu-id="43ead-158">尽量**在不回收实例的情况下应用配置更改**。</span><span class="sxs-lookup"><span data-stu-id="43ead-158">**Apply configuration changes without recycling** the instance when possible.</span></span> <span data-ttu-id="43ead-159">在许多情况下，可以更改 Azure 应用程序或服务的配置设置，而无需重新启动角色。</span><span class="sxs-lookup"><span data-stu-id="43ead-159">In many cases, the configuration settings for an Azure application or service can be changed without requiring the role to be restarted.</span></span> <span data-ttu-id="43ead-160">角色公开可以处理的事件以检测配置更改，并将其应用到应用程序中的组件。</span><span class="sxs-lookup"><span data-stu-id="43ead-160">Role expose events that can be handled to detect configuration changes and apply them to components within the application.</span></span> <span data-ttu-id="43ead-161">但是，对核心平台设置所做的某些更改需要重新启动角色。</span><span class="sxs-lookup"><span data-stu-id="43ead-161">However, some changes to the core platform settings do require a role to be restarted.</span></span> <span data-ttu-id="43ead-162">在构建组件和服务时，通过将其设计为可接受配置设置的更改而无需重新启动整个应用程序，来最大化可用性并将停机时间减到最小。</span><span class="sxs-lookup"><span data-stu-id="43ead-162">When building components and services, maximize availability and minimize downtime by designing them to accept changes to configuration settings without requiring the application as a whole to be restarted.</span></span>
* <span data-ttu-id="43ead-163">**在更新期间使用升级域实现零停机时间。**</span><span class="sxs-lookup"><span data-stu-id="43ead-163">**Use upgrade domains for zero downtime during updates.**</span></span> <span data-ttu-id="43ead-164">Azure 计算单元（如 Web 角色和辅助角色）已配置到升级域。</span><span class="sxs-lookup"><span data-stu-id="43ead-164">Azure compute units such as web and worker roles are allocated to upgrade domains.</span></span> <span data-ttu-id="43ead-165">升级域将角色实例分组在一起，因此，在发生滚动更新时，升级域中的每个角色都将轮流停止、更新并且重新启动。</span><span class="sxs-lookup"><span data-stu-id="43ead-165">Upgrade domains group role instances together so that, when a rolling update takes place, each role in the upgrade domain is stopped, updated, and restarted in turn.</span></span> <span data-ttu-id="43ead-166">这可以最大程度地减小对应用程序可用性的影响。</span><span class="sxs-lookup"><span data-stu-id="43ead-166">This minimizes the impact on application availability.</span></span> <span data-ttu-id="43ead-167">可以指定在部署服务时，应该为服务创建几个升级域。</span><span class="sxs-lookup"><span data-stu-id="43ead-167">You can specify how many upgrade domains should be created for a service when the service is deployed.</span></span>
  
  > [!NOTE]
  > <span data-ttu-id="43ead-168">角色还分布在容错域之间，每个容错域在服务器机架、电源和散热设置等方面彼此独立，以便将故障影响所有角色实例的可能性降到最低。</span><span class="sxs-lookup"><span data-stu-id="43ead-168">Roles are also distributed across fault domains, each of which is reasonably independent from other fault domains in terms of server rack, power, and cooling provision, in order to minimize the chance of a failure affecting all role instances.</span></span> <span data-ttu-id="43ead-169">这种分布是自动发生的，无法控制它。</span><span class="sxs-lookup"><span data-stu-id="43ead-169">This distribution occurs automatically, and you cannot control it.</span></span>
  > 
  > 
* <span data-ttu-id="43ead-170">**配置 Azure 虚拟机的可用性集。**</span><span class="sxs-lookup"><span data-stu-id="43ead-170">**Configure availability sets for Azure virtual machines.**</span></span> <span data-ttu-id="43ead-171">将两个或更多个虚拟机放在同一个可用性集中可保证这些虚拟机不会部署到同一个容错域。</span><span class="sxs-lookup"><span data-stu-id="43ead-171">Placing two or more virtual machines in the same availability set guarantees that these virtual machines will not be deployed to the same fault domain.</span></span> <span data-ttu-id="43ead-172">要最大化可用性，应该为系统使用的每个重要虚拟机创建多个实例，并将这些实例放在同一个可用性集中。</span><span class="sxs-lookup"><span data-stu-id="43ead-172">To maximize availability, you should create multiple instances of each critical virtual machine used by your system and place these instances in the same availability set.</span></span> <span data-ttu-id="43ead-173">如果正在运行多个满足不同目的的虚拟机，请为每个虚拟机创建可用性集。</span><span class="sxs-lookup"><span data-stu-id="43ead-173">If you are running multiple virtual machines that serve different purposes, create an availability set for each virtual machine.</span></span> <span data-ttu-id="43ead-174">将每个虚拟机的实例添加到每个可用性集。</span><span class="sxs-lookup"><span data-stu-id="43ead-174">Add instances of each virtual machine to each availability set.</span></span> <span data-ttu-id="43ead-175">例如，如果已创建不同的虚拟机来充当 Web 服务器和报告服务器，请为 Web 服务器创建一个可用性集，并为报告服务器创建另一个可用性集。</span><span class="sxs-lookup"><span data-stu-id="43ead-175">For example, if you have created separate virtual machines to act as a web server and a reporting server, create an availability set for the web server and another availability set for the reporting server.</span></span> <span data-ttu-id="43ead-176">将 Web 服务器虚拟机的实例添加到 Web 服务器可用性集，并将报告服务器虚拟机的实例添加到报告服务器可用性集。</span><span class="sxs-lookup"><span data-stu-id="43ead-176">Add instances of the web server virtual machine to the web server availability set, and add instances of the reporting server virtual machine to the reporting server availability set.</span></span>

## <a name="data-management"></a><span data-ttu-id="43ead-177">数据管理</span><span class="sxs-lookup"><span data-stu-id="43ead-177">Data management</span></span>

* <span data-ttu-id="43ead-178">**Azure 存储中的异地复制数据**。</span><span class="sxs-lookup"><span data-stu-id="43ead-178">**Geo-replicate data in Azure Storage**.</span></span> <span data-ttu-id="43ead-179">Azure 存储中的数据在数据中心自动复制。</span><span class="sxs-lookup"><span data-stu-id="43ead-179">Data in Azure Storage is automatically replicated within in a datacenter.</span></span> <span data-ttu-id="43ead-180">为了获得更高可用性，请使用读取访问异地冗余存储 (-RAGRS)，它将数据复制到次要区域，并提供次要位置数据的只读访问权限。</span><span class="sxs-lookup"><span data-stu-id="43ead-180">For even higher availability, use Read-access geo-redundant storage (-RAGRS), which replicates your data to a secondary region and provides read-only access to the data in the secondary location.</span></span> <span data-ttu-id="43ead-181">即使出现完全的区域性中断或灾难，数据也会得到持久保护。</span><span class="sxs-lookup"><span data-stu-id="43ead-181">The data is durable even in the case of a complete regional outage or a disaster.</span></span> <span data-ttu-id="43ead-182">有关详细信息，请参阅 [Azure 存储复制](/azure/storage/storage-redundancy)。</span><span class="sxs-lookup"><span data-stu-id="43ead-182">For more information, see [Azure Storage replication](/azure/storage/storage-redundancy).</span></span>
* <span data-ttu-id="43ead-183">**异地复制数据库**。</span><span class="sxs-lookup"><span data-stu-id="43ead-183">**Geo-replicate databases**.</span></span> <span data-ttu-id="43ead-184">Azure SQL 数据库和 Cosmos DB 都支持异地复制，因此可以在其他区域配置辅助数据库副本。</span><span class="sxs-lookup"><span data-stu-id="43ead-184">Azure SQL Database and Cosmos DB both support geo-replication, which enables you to configure secondary database replicas in other regions.</span></span> <span data-ttu-id="43ead-185">在数据中心发生服务中断或无法连接到主数据库时，可以使用辅助数据库进行查询和故障转移。</span><span class="sxs-lookup"><span data-stu-id="43ead-185">Secondary databases are available for querying and for failover in the case of a data center outage or the inability to connect to the primary database.</span></span> <span data-ttu-id="43ead-186">有关详细信息，请参阅[故障转移组和活动异地复制](/azure/sql-database/sql-database-geo-replication-overview)（SQL 数据库）和[如何使用 Azure Cosmos DB 全局分发数据](/azure/cosmos-db/distribute-data-globally)。</span><span class="sxs-lookup"><span data-stu-id="43ead-186">For more information, see [Failover groups and active geo-replication](/azure/sql-database/sql-database-geo-replication-overview) (SQL Database) and [How to distribute data globally with Azure Cosmos DB?](/azure/cosmos-db/distribute-data-globally).</span></span>
* <span data-ttu-id="43ead-187">尽可能**使用乐观并发访问和最终一致性**。</span><span class="sxs-lookup"><span data-stu-id="43ead-187">**Use optimistic concurrency and eventual consistency** where possible.</span></span> <span data-ttu-id="43ead-188">通过锁定（悲观并发）阻止访问资源的事务可能会导致性能不佳，并大幅降低可用性。</span><span class="sxs-lookup"><span data-stu-id="43ead-188">Transactions that block access to resources through locking (pessimistic concurrency) can cause poor performance and considerably reduce availability.</span></span> <span data-ttu-id="43ead-189">这些问题在分布式系统中可能会变得特别严重。</span><span class="sxs-lookup"><span data-stu-id="43ead-189">These problems can become especially acute in distributed systems.</span></span> <span data-ttu-id="43ead-190">在许多情况下，谨慎的设计和方法（例如分区）可以将发生更新冲突的可能性降到最低。</span><span class="sxs-lookup"><span data-stu-id="43ead-190">In many cases, careful design and techniques such as partitioning can minimize the chances of conflicting updates occurring.</span></span> <span data-ttu-id="43ead-191">复制数据或者从独立更新的存储中读取数据时，数据只会保持最终一致性。</span><span class="sxs-lookup"><span data-stu-id="43ead-191">Where data is replicated, or is read from a separately updated store, the data will only be eventually consistent.</span></span> <span data-ttu-id="43ead-192">但其优点通常超越了使用事务来确保即时一致性所导致的可用性影响。</span><span class="sxs-lookup"><span data-stu-id="43ead-192">But the advantages usually far outweigh the impact on availability of using transactions to ensure immediate consistency.</span></span>
* <span data-ttu-id="43ead-193">**使用定期备份和时间点还原**，并确保符合恢复点目标 (RPO)。</span><span class="sxs-lookup"><span data-stu-id="43ead-193">**Use periodic backup and point-in-time restore**, and ensure it meets the Recovery Point Objective (RPO).</span></span> <span data-ttu-id="43ead-194">定期自动备份未保留在其他位置的数据，并确认可以在发生故障时可靠还原数据和应用程序本身。</span><span class="sxs-lookup"><span data-stu-id="43ead-194">Regularly and automatically back up data that is not preserved elsewhere, and verify you can reliably restore both the data and the application itself should a failure occur.</span></span> <span data-ttu-id="43ead-195">数据复制并不是备份功能，因为故障、错误或恶意操作造成的错误和不一致性会复制到所有存储中。</span><span class="sxs-lookup"><span data-stu-id="43ead-195">Data replication is not a backup feature because errors and inconsistencies introduced through failure, error, or malicious operations will be replicated across all stores.</span></span> <span data-ttu-id="43ead-196">备份过程必须是安全的，这样才能保护传输中和存储中的数据。</span><span class="sxs-lookup"><span data-stu-id="43ead-196">The backup process must be secure to protect the data in transit and in storage.</span></span> <span data-ttu-id="43ead-197">数据库或部分数据存储通常可以使用事务日志恢复到以前的某个时间点。</span><span class="sxs-lookup"><span data-stu-id="43ead-197">Databases or parts of a data store can usually be recovered to a previous point in time by using transaction logs.</span></span> <span data-ttu-id="43ead-198">Microsoft Azure 针对存储在 Azure SQL 数据库中的数据提供备份工具。</span><span class="sxs-lookup"><span data-stu-id="43ead-198">Microsoft Azure provides a backup facility for data stored in Azure SQL Database.</span></span> <span data-ttu-id="43ead-199">数据将导出到 Azure Blob 存储上的备份包，并且可下载到存储的安全本地位置。</span><span class="sxs-lookup"><span data-stu-id="43ead-199">The data is exported to a backup package on Azure blob storage, and can be downloaded to a secure on-premises location for storage.</span></span>
* <span data-ttu-id="43ead-200">**启用高可用性选项来维护 Azure Redis 缓存的辅助副本。**</span><span class="sxs-lookup"><span data-stu-id="43ead-200">**Enable the high availability option to maintain a secondary copy of an Azure Redis cache.**</span></span> <span data-ttu-id="43ead-201">使用 Azure Redis 缓存时，请选择“标准”选项来维护内容的辅助副本。</span><span class="sxs-lookup"><span data-stu-id="43ead-201">When using Azure Redis Cache, choose the standard option to maintain a secondary copy of the contents.</span></span> <span data-ttu-id="43ead-202">有关详细信息，请参阅 [Create a cache in Azure Redis Cache](https://msdn.microsoft.com/library/dn690516.aspx)（在 Azure Redis 缓存中创建缓存）。</span><span class="sxs-lookup"><span data-stu-id="43ead-202">For more information, see [Create a cache in Azure Redis Cache](https://msdn.microsoft.com/library/dn690516.aspx).</span></span>

## <a name="errors-and-failures"></a><span data-ttu-id="43ead-203">错误和故障</span><span class="sxs-lookup"><span data-stu-id="43ead-203">Errors and failures</span></span>
* <span data-ttu-id="43ead-204">**引入超时的概念。**</span><span class="sxs-lookup"><span data-stu-id="43ead-204">**Introduce the concept of a timeout.**</span></span> <span data-ttu-id="43ead-205">服务和资源可能会变为不可用，导致请求失败。</span><span class="sxs-lookup"><span data-stu-id="43ead-205">Services and resources may become unavailable, causing requests to fail.</span></span> <span data-ttu-id="43ead-206">请确保应用的超时适合每个服务或资源，以及访问服务或资源的客户端。</span><span class="sxs-lookup"><span data-stu-id="43ead-206">Ensure that the timeouts you apply are appropriate for each service or resource as well as the client that is accessing them.</span></span> <span data-ttu-id="43ead-207">（在某些情况下，对特定的客户端实例允许较长的超时可能比较合适，具体取决于客户端正在执行的上下文和其他操作）。太短的超时可能对产生较长延迟的服务和资源造成过多的重试操作。</span><span class="sxs-lookup"><span data-stu-id="43ead-207">(In some cases, it may be appropriate to allow a longer timeout for a particular instance of a client, depending on the context and other actions that the client is performing.) Very short timeouts may cause excessive retry operations for services and resources that have considerable latency.</span></span> <span data-ttu-id="43ead-208">如果大量的请求正在排队等待服务或资源做出响应，则很长的超时可能会导致阻塞。</span><span class="sxs-lookup"><span data-stu-id="43ead-208">Very long timeouts can cause blocking if a large number of requests are queued, waiting for a service or resource to respond.</span></span>
* <span data-ttu-id="43ead-209">**重试暂时性故障导致的失败操作。**</span><span class="sxs-lookup"><span data-stu-id="43ead-209">**Retry failed operations caused by transient faults.**</span></span> <span data-ttu-id="43ead-210">设计重试策略，以便在所有服务和资源原本不支持自动连接重试的情况下访问这些服务和资源。</span><span class="sxs-lookup"><span data-stu-id="43ead-210">Design a retry strategy for access to all services and resources where they do not inherently support automatic connection retry.</span></span> <span data-ttu-id="43ead-211">使用适当的策略，规定随着故障次数的增加，每两次重试的间隔延迟时间也会增加，以避免资源过载，并允许资源正常恢复和处理排队的请求。</span><span class="sxs-lookup"><span data-stu-id="43ead-211">Use a strategy that includes an increasing delay between retries as the number of failures increases, to prevent overloading of the resource and to allow it to gracefully recover and handle queued requests.</span></span> <span data-ttu-id="43ead-212">以很短的延迟连续重试可能会使问题恶化。</span><span class="sxs-lookup"><span data-stu-id="43ead-212">Continual retries with very short delays are likely to exacerbate the problem.</span></span>
* <span data-ttu-id="43ead-213">在远程服务时不可用时**停止发送请求以避免级联故障**。</span><span class="sxs-lookup"><span data-stu-id="43ead-213">**Stop sending requests to avoid cascading failures** when remote services are unavailable.</span></span> <span data-ttu-id="43ead-214">在某些情况下，暂时性故障或其他故障（严重性范围从部分连接断开到服务完全故障）花费比预期更长的时间才能恢复正常。</span><span class="sxs-lookup"><span data-stu-id="43ead-214">There may be situations in which transient or other faults, ranging in severity from a partial loss of connectivity to the complete failure of a service, take much longer than expected to return to normal.</span></span> <span data-ttu-id="43ead-215">此外，如果服务非常繁忙，系统中某个部件的故障可能会导致级联故障，并导致许多操作在占用重要系统资源（例如内存、线程和数据库连接）时遭到阻止。</span><span class="sxs-lookup"><span data-stu-id="43ead-215">Additionally, if a service is very busy, failure in one part of the system may lead to cascading failures, and result in many operations becoming blocked while holding onto critical system resources such as memory, threads, and database connections.</span></span> <span data-ttu-id="43ead-216">应用程序不应连续重试不太可能成功的操作，而应快速接受操作失败的事实，并适当地处理这种失败。</span><span class="sxs-lookup"><span data-stu-id="43ead-216">Instead of continually retrying an operation that is unlikely to succeed, the application should quickly accept that the operation has failed, and gracefully handle this failure.</span></span> <span data-ttu-id="43ead-217">可以使用断路器模式在定义的时间段内拒绝对特定操作的请求。</span><span class="sxs-lookup"><span data-stu-id="43ead-217">You can use the circuit breaker pattern to reject requests for specific operations for defined periods.</span></span> <span data-ttu-id="43ead-218">有关详细信息，请参阅[断路器模式](../patterns/circuit-breaker.md)。</span><span class="sxs-lookup"><span data-stu-id="43ead-218">For more information, see [Circuit Breaker Pattern](../patterns/circuit-breaker.md).</span></span>
* <span data-ttu-id="43ead-219">**组建或故障回复到多个组件**以缓解特定服务脱机或不可用所造成的影响。</span><span class="sxs-lookup"><span data-stu-id="43ead-219">**Compose or fall back to multiple components** to mitigate the impact of a specific service being offline or unavailable.</span></span> <span data-ttu-id="43ead-220">将应用程序设计为尽可能利用多个实例且不影响操作和现有连接。</span><span class="sxs-lookup"><span data-stu-id="43ead-220">Design applications to take advantage of multiple instances without affecting operation and existing connections where possible.</span></span> <span data-ttu-id="43ead-221">使用多个实例并分散它们之间的请求，检测并避免向故障的实例发送请求，以便最大化可用性。</span><span class="sxs-lookup"><span data-stu-id="43ead-221">Use multiple instances and distribute requests between them, and detect and avoid sending requests to failed instances, in order to maximize availability.</span></span>
* <span data-ttu-id="43ead-222">尽可能**故障回复到不同的服务或工作流**。</span><span class="sxs-lookup"><span data-stu-id="43ead-222">**Fall back to a different service or workflow** where possible.</span></span> <span data-ttu-id="43ead-223">例如，如果写入 SQL 数据库失败，请暂时会数据存储在 Blob 存储中。</span><span class="sxs-lookup"><span data-stu-id="43ead-223">For example, if writing to SQL Database fails, temporarily store data in blob storage.</span></span> <span data-ttu-id="43ead-224">提供一个工具用于在服务可用时将 Blob 存储中的数据重新写入 SQL 数据库。</span><span class="sxs-lookup"><span data-stu-id="43ead-224">Provide a facility to replay the writes in blob storage to SQL Database when the service becomes available.</span></span> <span data-ttu-id="43ead-225">在某些情况下，失败的操作可能有替代操作允许应用程序继续工作，即使组件或服务发生故障。</span><span class="sxs-lookup"><span data-stu-id="43ead-225">In some cases, a failed operation may have an alternative action that allows the application to continue to work even when a component or service fails.</span></span> <span data-ttu-id="43ead-226">如果可能，请检测故障并将请求重定向到其他可提供适当替代功能的服务，或者在主服务脱机时，备份或减少可保持核心操作的功能实例。</span><span class="sxs-lookup"><span data-stu-id="43ead-226">If possible, detect failures and redirect requests to other services that can offer a suitable alternative functionality, or to back up or reduced functionality instances that can maintain core operations while the primary service is offline.</span></span>

## <a name="monitoring-and-disaster-recovery"></a><span data-ttu-id="43ead-227">监视和灾难恢复</span><span class="sxs-lookup"><span data-stu-id="43ead-227">Monitoring and disaster recovery</span></span>
* <span data-ttu-id="43ead-228">**针对可能的故障和故障事件提供丰富的检测**，以将情况汇报给操作人员。</span><span class="sxs-lookup"><span data-stu-id="43ead-228">**Provide rich instrumentation for likely failures and failure events** to report the situation to operations staff.</span></span> <span data-ttu-id="43ead-229">针对可能但尚未发生的故障提供足够的数据，以便操作人员确定其原因，缓解局面，并确保系统保持可用。</span><span class="sxs-lookup"><span data-stu-id="43ead-229">For failures that are likely but have not yet occurred, provide sufficient data to enable operations staff to determine the cause, mitigate the situation, and ensure that the system remains available.</span></span> <span data-ttu-id="43ead-230">针对已发生的故障，应用程序应该将适当的错误消息返回给用户，但仍然尝试继续运行，尽管功能降低。</span><span class="sxs-lookup"><span data-stu-id="43ead-230">For failures that have already occurred, the application should return an appropriate error message to the user but attempt to continue running, albeit with reduced functionality.</span></span> <span data-ttu-id="43ead-231">在各种情况下，监视系统应该捕获完整的详细信息，以便操作人员实施快速恢复，并根据需要让设计人员和开发人员修改系统，以防止再次发生此情况。</span><span class="sxs-lookup"><span data-stu-id="43ead-231">In all cases, the monitoring system should capture comprehensive details to enable operations staff to effect a quick recovery, and if necessary, for designers and developers to modify the system to prevent the situation from arising again.</span></span>
* <span data-ttu-id="43ead-232">**通过实施检查功能来监视系统运行状况。**</span><span class="sxs-lookup"><span data-stu-id="43ead-232">**Monitor system health by implementing checking functions.**</span></span> <span data-ttu-id="43ead-233">应用程序的运行状况和性能可能在不同时间出现不明显的降级，直到发生故障为止。</span><span class="sxs-lookup"><span data-stu-id="43ead-233">The health and performance of an application can degrade over time, without being noticeable until it fails.</span></span> <span data-ttu-id="43ead-234">实施探测或定期从应用程序外部执行检查功能。</span><span class="sxs-lookup"><span data-stu-id="43ead-234">Implement probes or check functions that are executed regularly from outside the application.</span></span> <span data-ttu-id="43ead-235">这些检查与度量整个应用程序、应用程序的单个部件、应用程序使用的单个服务和单个组件的响应时间一样简单。</span><span class="sxs-lookup"><span data-stu-id="43ead-235">These checks can be as simple as measuring response time for the application as a whole, for individual parts of the application, for individual services that the application uses, or for individual components.</span></span> <span data-ttu-id="43ead-236">检查功能可以一些进程来确保生成有效的结果、度量延迟、检查可用性，并从系统中提取信息。</span><span class="sxs-lookup"><span data-stu-id="43ead-236">Check functions can execute processes to ensure they produce valid results, measure latency and check availability, and extract information from the system.</span></span>
* <span data-ttu-id="43ead-237">**定期测试所有故障转移和故障回复系统**，以确保它们可用并按预期工作。</span><span class="sxs-lookup"><span data-stu-id="43ead-237">**Regularly test all failover and fallback systems** to ensure they are available and operate as expected.</span></span> <span data-ttu-id="43ead-238">对系统和操作的更改可能会影响故障转移和故障回复功能，但是在主系统发生故障或过载之前可能无法检测到这种影响。</span><span class="sxs-lookup"><span data-stu-id="43ead-238">Changes to systems and operations may affect failover and fallback functions, but the impact may not be detected until the main system fails or becomes overloaded.</span></span> <span data-ttu-id="43ead-239">先测试系统，以防在运行时弥补实时问题。</span><span class="sxs-lookup"><span data-stu-id="43ead-239">Test it before it is required to compensate for a live problem at runtime.</span></span>
* <span data-ttu-id="43ead-240">**测试监视系统。**</span><span class="sxs-lookup"><span data-stu-id="43ead-240">**Test the monitoring systems.**</span></span> <span data-ttu-id="43ead-241">自动化故障转移和故障回复系统，以及使用仪表板手动进行系统运行状况和性能可视化，都依赖于监视和检测功能的正常运行。</span><span class="sxs-lookup"><span data-stu-id="43ead-241">Automated failover and fallback systems, and manual visualization of system health and performance by using dashboards, all depend on monitoring and instrumentation functioning correctly.</span></span> <span data-ttu-id="43ead-242">如果这些元素发生故障、遗漏重要信息或报告错误的数据，操作人员可能不知道系统不正常或即将发生故障。</span><span class="sxs-lookup"><span data-stu-id="43ead-242">If these elements fail, miss critical information, or report inaccurate data, an operator might not realize that the system is unhealthy or failing.</span></span>
* <span data-ttu-id="43ead-243">**跟踪长时间运行的工作流的进度**并在故障时重试。</span><span class="sxs-lookup"><span data-stu-id="43ead-243">**Track the progress of long-running workflows** and retry on failure.</span></span> <span data-ttu-id="43ead-244">长时间运行的工作流通常由多个步骤组成。</span><span class="sxs-lookup"><span data-stu-id="43ead-244">Long-running workflows are often composed of multiple steps.</span></span> <span data-ttu-id="43ead-245">确保每个步骤都是独立且可以重试的，以最大程度地减少整个工作流需要回滚，或需要执行多个补偿事务的可能性。</span><span class="sxs-lookup"><span data-stu-id="43ead-245">Ensure that each step is independent and can be retried to minimize the chance that the entire workflow will need to be rolled back, or that multiple compensating transactions need to be executed.</span></span> <span data-ttu-id="43ead-246">通过实施[计划程序代理监督程序模式](https://msdn.microsoft.com/library/dn589780.aspx)等模式，来监视和管理长时间运行的工作流的进度。</span><span class="sxs-lookup"><span data-stu-id="43ead-246">Monitor and manage the progress of long-running workflows by implementing a pattern such as [Scheduler Agent Supervisor Pattern](https://msdn.microsoft.com/library/dn589780.aspx).</span></span>
* <span data-ttu-id="43ead-247">**规划灾难恢复。**</span><span class="sxs-lookup"><span data-stu-id="43ead-247">**Plan for disaster recovery.**</span></span> <span data-ttu-id="43ead-248">创建一个可接受的且经过完全测试的计划，从可能影响系统可用性的任何故障类型中恢复。</span><span class="sxs-lookup"><span data-stu-id="43ead-248">Create an accepted, fully-tested plan for recovery from any type of failure that may affect system availability.</span></span> <span data-ttu-id="43ead-249">为任意任务关键型应用程序选择多站点灾难恢复体系结构。</span><span class="sxs-lookup"><span data-stu-id="43ead-249">Choose a multi-site disaster recovery architecture for any mission-critical applications.</span></span> <span data-ttu-id="43ead-250">标识包括自动化和测试在内的灾难恢复计划的特定所有者。</span><span class="sxs-lookup"><span data-stu-id="43ead-250">Identify a specific owner of the disaster recovery plan, including automation and testing.</span></span> <span data-ttu-id="43ead-251">确保此计划有案可稽并且尽可能自动化该过程。</span><span class="sxs-lookup"><span data-stu-id="43ead-251">Ensure the plan is well-documented, and automate the process as much as possible.</span></span> <span data-ttu-id="43ead-252">为所有引用和事务数据制定备份策略，并定期测试这些备份的恢复效果。</span><span class="sxs-lookup"><span data-stu-id="43ead-252">Establish a backup strategy for all reference and transactional data, and test the restoration of these backups regularly.</span></span> <span data-ttu-id="43ead-253">培训操作人员执行该计划，并进行常规灾难模拟以验证和改进计划。</span><span class="sxs-lookup"><span data-stu-id="43ead-253">Train operations staff to execute the plan, and perform regular disaster simulations to validate and improve the plan.</span></span>
